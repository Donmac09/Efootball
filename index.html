<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Donmac Efootball - Professional Gaming Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0f1e 0%, #1a1f30 100%);
            min-height: 100vh;
            color: #ffffff;
        }

        .navbar {
            background: rgba(10, 15, 30, 0.98);
            padding: 1rem 5%;
            box-shadow: 0 2px 20px rgba(0, 212, 255, 0.3);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #00d4ff;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #00d4ff;
            font-size: 2rem;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: #00d4ff;
        }

        .mobile-nav {
            display: none;
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: rgba(10, 15, 30, 0.98);
            border-bottom: 2px solid #00d4ff;
            padding: 1rem;
            z-index: 999;
            flex-direction: column;
            gap: 1rem;
        }

        .mobile-nav.active {
            display: flex;
        }

        .mobile-nav a, .mobile-nav button {
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border: none;
            color: white;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1rem;
        }

        .btn {
            padding: 0.6rem 1.8rem;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #00d4ff;
            color: #00d4ff;
        }

        .btn-secondary:hover {
            background: #00d4ff;
            color: #0a0f1e;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            border-radius: 20px;
        }

        .btn-back::before {
            content: "‚Üê";
            font-size: 1.2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 5%;
            margin-top: 80px;
        }

        .online-counter {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(157, 78, 221, 0.2));
            border: 1px solid #00d4ff;
            border-radius: 50px;
            padding: 0.5rem 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .hero {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .hero-content h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .welcome-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 25px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
        }

        .stat-card h3 {
            color: #b0b0b0;
            font-size: 0.9rem;
        }

        .stat-card .value {
            font-size: 1.8rem;
            color: #00d4ff;
            font-weight: bold;
        }

        .mode-selection {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            flex: 1;
            min-width: 150px;
        }

        .mode-card.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.2);
        }

        .mode-card h3 {
            color: #00d4ff;
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .match-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 1.2rem;
        }

        .match-card h3 {
            color: #00d4ff;
            margin-bottom: 0.5rem;
        }

        .match-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .match-actions button {
            flex: 1;
            padding: 0.6rem;
        }

        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: #1a1f30;
            border: 2px solid #00d4ff;
            border-radius: 20px;
            display: none;
            z-index: 2000;
        }

        .chat-container.active {
            display: block;
        }

        .chat-header {
            padding: 1rem;
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            border-radius: 18px 18px 0 0;
            display: flex;
            justify-content: space-between;
        }

        .chat-messages {
            height: 250px;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 0.8rem;
            padding: 0.6rem;
            border-radius: 12px;
            max-width: 80%;
        }

        .message.sent {
            background: #00d4ff;
            color: #0a0f1e;
            margin-left: auto;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-input {
            display: flex;
            padding: 0.8rem;
            gap: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .chat-input input {
            flex: 1;
            padding: 0.6rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
        }

        .league-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .league-card {
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .league-card h3 {
            color: #00d4ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1f30;
            border: 2px solid #00d4ff;
            border-radius: 20px;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: #00d4ff;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: #00d4ff;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
        }

        .country-input-container {
            position: relative;
        }

        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background: #1a1f30;
            border: 1px solid #00d4ff;
            border-radius: 0 0 10px 10px;
            display: none;
            z-index: 1000;
        }

        .suggestions-list.active {
            display: block;
        }

        .suggestion-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background: rgba(0,212,255,0.2);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .leaderboard-table th {
            background: rgba(0,212,255,0.2);
            padding: 0.8rem;
            text-align: left;
        }

        .leaderboard-table td {
            padding: 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .rank-1 { background: linear-gradient(90deg, rgba(255,215,0,0.2), transparent); }
        .rank-2 { background: linear-gradient(90deg, rgba(192,192,192,0.2), transparent); }
        .rank-3 { background: linear-gradient(90deg, rgba(205,127,50,0.2), transparent); }

        .winner-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .winner-card {
            background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(157,78,221,0.2));
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 1.2rem;
        }

        .winner-card h3 {
            color: #00d4ff;
            margin-bottom: 1rem;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .podium-1 .podium-card {
            border-color: gold;
            transform: scale(1.1);
        }
        .podium-2 .podium-card { border-color: silver; }
        .podium-3 .podium-card { border-color: #cd7f32; }

        .podium-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid;
            border-radius: 10px;
            padding: 0.8rem;
            min-width: 100px;
            text-align: center;
        }

        .podium-rank {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .podium-1 .podium-rank { color: gold; }
        .podium-2 .podium-rank { color: silver; }
        .podium-3 .podium-rank { color: #cd7f32; }

        .ai-badge {
            background: rgba(0,212,255,0.2);
            border: 1px solid #00d4ff;
            border-radius: 20px;
            padding: 0.4rem 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin: 1rem 0;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1a1f30;
            border-left: 4px solid #00d4ff;
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            animation: slideIn 0.3s ease;
            z-index: 4000;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .forgot-password-link {
            text-align: center;
            margin-top: 0.5rem;
        }

        .forgot-password-link a {
            color: #00d4ff;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .forgot-password-link a:hover {
            text-decoration: underline;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .mobile-menu-btn { display: block; }
            .nav-links { display: none; }
            .stats-grid { grid-template-columns: 1fr; }
            .mode-selection { flex-direction: column; }
            .chat-container { width: 100%; bottom: 0; right: 0; }
        }
    </style>
    <!-- Nhost SDK -->
    <script type="module">
        import { NhostClient } from 'https://cdn.jsdelivr.net/npm/@nhost/nhost-js@2.1.1/+esm'
        window.NhostClient = NhostClient
    </script>
</head>
<body>
    <nav class="navbar">
        <span class="logo" onclick="window.showHome()">Donmac Efootball</span>
        <button class="mobile-menu-btn" onclick="window.toggleMobileMenu()">‚ò∞</button>
        <div class="nav-links">
            <a onclick="window.showHome()">Home</a>
            <a onclick="window.showFreePlay()">Free Play</a>
            <a onclick="window.showLeagues()">Leagues</a>
            <a onclick="window.showLeaderboard()">Leaderboard</a>
            <a onclick="window.showProfile()">Profile</a>
            <button class="btn btn-primary" id="loginBtn" onclick="window.showLoginModal()">Login</button>
            <button class="btn btn-secondary" id="registerBtn" onclick="window.showRegisterModal()">Register</button>
            <button class="btn btn-secondary" id="logoutBtn" onclick="window.logout()" style="display: none;">Logout</button>
            <button class="btn btn-primary" id="adminBtn" onclick="window.showAdminModal()" style="display: none;">Admin</button>
        </div>
    </nav>

    <div class="mobile-nav" id="mobileNav">
        <a onclick="window.showHome(); window.toggleMobileMenu()">üè† Home</a>
        <a onclick="window.showFreePlay(); window.toggleMobileMenu()">‚öΩ Free Play</a>
        <a onclick="window.showLeagues(); window.toggleMobileMenu()">üèÜ Leagues</a>
        <a onclick="window.showLeaderboard(); window.toggleMobileMenu()">üìä Leaderboard</a>
        <a onclick="window.showProfile(); window.toggleMobileMenu()">üë§ Profile</a>
        <button class="btn btn-primary" id="mobileLoginBtn" onclick="window.showLoginModal(); window.toggleMobileMenu()">Login</button>
        <button class="btn btn-secondary" id="mobileRegisterBtn" onclick="window.showRegisterModal(); window.toggleMobileMenu()">Register</button>
        <button class="btn btn-secondary" id="mobileLogoutBtn" onclick="window.logout(); window.toggleMobileMenu()" style="display: none;">Logout</button>
    </div>

    <div class="container" id="mainContent">
        <button class="btn-back" id="backButton" onclick="window.goBack()" style="display: none;"></button>

        <div id="heroSection" class="hero">
            <div class="hero-content">
                <h1>Welcome to Donmac Efootball</h1>
                <p>Join competitive leagues and climb the ranks!</p>
                <button class="btn btn-primary" onclick="window.showRegisterModal()">Get Started</button>
            </div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="welcome-card">
                <h2>Welcome, <span id="playerName"></span>!</h2>
                <p id="playerStatus"></p>
            </div>

            <div class="winner-section">
                <div class="winner-card">
                    <h3>üèÜ Current Free Play Phase</h3>
                    <div id="freePlayPhaseTop3"></div>
                </div>
                <div class="winner-card">
                    <h3>üèÜ League Champions</h3>
                    <div id="leagueChampions"></div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><h3>Free Play Pts</h3><div class="value" id="freePlayPoints">0</div></div>
                <div class="stat-card"><h3>League Pts</h3><div class="value" id="leaguePoints">0</div></div>
                <div class="stat-card"><h3>Matches</h3><div class="value" id="totalMatches">0</div></div>
                <div class="stat-card"><h3>Goal Diff</h3><div class="value" id="goalDifference">0</div></div>
            </div>

            <div class="mode-selection">
                <div class="mode-card" onclick="window.switchMode('freeplay')" id="freeplayMode">
                    <h3>‚öΩ Free Play</h3>
                    <p>Casual matches</p>
                </div>
                <div class="mode-card" onclick="window.switchMode('league')" id="leagueMode">
                    <h3>üèÜ League Mode</h3>
                    <p>Competitive</p>
                </div>
            </div>

            <div id="freeplaySection">
                <div class="welcome-card">
                    <div class="online-counter" id="onlineCounter">
                        <span class="online-dot"></span>
                        <span>Loading players online...</span>
                    </div>
                    <h3>Find Opponent</h3>
                    <button class="btn btn-primary" onclick="window.findOpponent()" style="width:100%;">üîç Search for Opponent</button>
                </div>

                <div class="welcome-card">
                    <h3>Your Active Matches</h3>
                    <div id="activeMatches"></div>
                </div>

                <div class="welcome-card">
                    <h3>Free Play Leaderboard</h3>
                    <div style="overflow-x:auto;">
                        <table class="leaderboard-table">
                            <thead><tr><th>Rank</th><th>Player</th><th>Country</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr></thead>
                            <tbody id="freePlayLeaderboardBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="leagueSection" style="display:none;">
                <div class="welcome-card">
                    <h3>Available Leagues</h3>
                    <div class="league-grid" id="leagueList"></div>
                </div>
                <div id="leagueStandings" style="display:none;">
                    <div class="welcome-card">
                        <h3>Your League Standings</h3>
                        <div style="overflow-x:auto;">
                            <table class="leaderboard-table">
                                <thead><tr><th>Rank</th><th>Player</th><th>Country</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr></thead>
                                <tbody id="leagueLeaderboardBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="profilePage" style="display:none;">
            <button class="btn-back" onclick="window.showDashboard()">Back</button>
            <div class="welcome-card">
                <h2>Player Profile</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Name</h3><div class="value" id="profileName"></div></div>
                    <div class="stat-card"><h3>Country</h3><div class="value" id="profileCountry"></div></div>
                    <div class="stat-card"><h3>eFootball User</h3><div class="value" id="profileEfootball"></div></div>
                    <div class="stat-card"><h3>League</h3><div class="value" id="profileLeague"></div></div>
                </div>
                <button class="btn btn-primary" onclick="window.showEditProfile()">Edit Profile</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Login</h2><button class="close-btn" onclick="window.closeModal('loginModal')">&times;</button></div>
            <form onsubmit="window.handleLogin(event)">
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPassword" required></div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
            </form>
            <div class="forgot-password-link">
                <a onclick="window.showForgotPasswordModal()">Forgot Password?</a>
            </div>
            <p style="text-align:center; margin-top:1rem;">Don't have an account? <a onclick="window.switchToRegister()" style="color:#00d4ff;cursor:pointer;">Register</a></p>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Register</h2><button class="close-btn" onclick="window.closeModal('registerModal')">&times;</button></div>
            <form onsubmit="window.handleRegister(event)">
                <div class="form-group"><label>Full Name</label><input type="text" id="regName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="regEmail" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="regPassword" required></div>
                <div class="form-group">
                    <label>Country</label>
                    <div class="country-input-container">
                        <input type="text" id="regCountry" placeholder="Type your country" oninput="window.filterCountries(this.value)" required>
                        <div id="countrySuggestions" class="suggestions-list"></div>
                    </div>
                </div>
                <div class="form-group"><label>eFootball Username</label><input type="text" id="regEfootball" required></div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Register</button>
            </form>
            <p style="text-align:center; margin-top:1rem;">Already have an account? <a onclick="window.switchToLogin()" style="color:#00d4ff;cursor:pointer;">Login</a></p>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Reset Password</h2><button class="close-btn" onclick="window.closeModal('forgotPasswordModal')">&times;</button></div>
            <form onsubmit="window.handleForgotPassword(event)">
                <div class="form-group"><label>Email</label><input type="email" id="forgotEmail" placeholder="Enter your email" required></div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Send Reset Link</button>
            </form>
            <p style="text-align:center; margin-top:1rem;">Remember your password? <a onclick="window.switchToLogin()" style="color:#00d4ff;cursor:pointer;">Login</a></p>
        </div>
    </div>

    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Submit Result</h2><button class="close-btn" onclick="window.closeModal('resultModal')">&times;</button></div>
            <form onsubmit="window.submitResult(event)">
                <div class="form-group"><label>Match ID</label><input type="text" id="resultMatchId" readonly></div>
                <div class="form-group"><label>Opponent</label><input type="text" id="resultOpponent" readonly></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                    <div class="form-group"><label>Your Score</label><input type="number" id="yourScore" min="0" required></div>
                    <div class="form-group"><label>Opponent Score</label><input type="number" id="opponentScore" min="0" required></div>
                </div>
                <div class="ai-badge">ü§ñ AI VERIFICATION ACTIVE</div>
                <div class="form-group"><label>Screenshot</label><input type="file" id="matchScreenshot" accept="image/*" required></div>
                <div class="form-group"><label>Video (Optional)</label><input type="file" id="matchVideo" accept="video/*"></div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Submit</button>
            </form>
        </div>
    </div>

    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Profile</h2><button class="close-btn" onclick="window.closeModal('editProfileModal')">&times;</button></div>
            <form onsubmit="window.updateProfile(event)">
                <div class="form-group"><label>Full Name</label><input type="text" id="editName" required></div>
                <div class="form-group">
                    <label>Country</label>
                    <div class="country-input-container">
                        <input type="text" id="editCountry" oninput="window.filterEditCountries(this.value)" required>
                        <div id="editCountrySuggestions" class="suggestions-list"></div>
                    </div>
                </div>
                <div class="form-group"><label>eFootball Username</label><input type="text" id="editEfootball" required></div>
                <button type="submit" class="btn btn-primary" style="width:100%;">Update</button>
            </form>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header"><span>Chat with <span id="chatOpponent"></span></span><button onclick="window.closeChat()">‚úï</button></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input"><input type="text" id="chatInput" placeholder="Type..."><button onclick="window.sendMessage()">Send</button></div>
    </div>

    <div id="toastContainer"></div>

    <script>
        // Configuration
        const ADMIN_EMAIL = 'donmacdatahub@gmail.com';

        // Global variables
        let nhost = null;
        window.currentUser = null; // Made global for easier access across scripts
        let currentChatMatch = null;
        let onlineInterval;
        let onlineUsers = 0;
        let initResolve;
        let initReject;

        // Create a promise that resolves when nhost is initialized
        const initPromise = new Promise((resolve, reject) => {
            initResolve = resolve;
            initReject = reject;
        });

        // Countries list
        const COUNTRIES = [
            "Argentina", "Australia", "Austria", "Belgium", "Brazil", "Bulgaria", "Canada",
            "Chile", "China", "Colombia", "Costa Rica", "Croatia", "Czech Republic", "Denmark",
            "Ecuador", "Egypt", "England", "Finland", "France", "Germany", "Ghana", "Greece",
            "Hungary", "Iceland", "India", "Indonesia", "Iran", "Ireland", "Israel", "Italy",
            "Ivory Coast", "Japan", "Kazakhstan", "Kenya", "Malaysia", "Mexico", "Morocco",
            "Netherlands", "New Zealand", "Nigeria", "Norway", "Peru", "Philippines", "Poland",
            "Portugal", "Qatar", "Romania", "Russia", "Saudi Arabia", "Scotland", "Senegal",
            "Serbia", "Singapore", "Slovakia", "Slovenia", "South Africa", "South Korea", "Spain",
            "Sweden", "Switzerland", "Thailand", "Tunisia", "Turkey", "Ukraine", "United Arab Emirates",
            "United Kingdom", "United States", "Uruguay", "Venezuela", "Vietnam", "Wales", "Zimbabwe"
        ];

        // Helper function to ensure nhost is initialized
        async function ensureNhost() {
            try {
                await initPromise;
                if (!nhost) {
                    throw new Error('Nhost initialization failed');
                }
                return nhost;
            } catch (error) {
                console.error('Error in ensureNhost:', error);
                throw error;
            }
        }

        // Helper function for GraphQL requests
        async function makeGraphQLRequest(query, variables = {}) {
            try {
                const nhost = await ensureNhost();
                const { data, error } = await nhost.graphql.request(query, variables);

                if (error) {
                    console.error('GraphQL error:', error);
                    throw error;
                }

                return data;
            } catch (error) {
                console.error('Failed to make GraphQL request:', error);
                throw error;
            }
        }

        // Initialize the application with fallback
        async function initializeApp() {
            try {
                window.showToast('Initializing app...', 'info');

                // NhostClient should be available on window from the module script
                const Client = window.NhostClient || (typeof NhostClient !== 'undefined' ? NhostClient : null);

                if (Client) {
                    try {
                        // Initialize Nhost
                        nhost = new Client({
                            subdomain: 'kodpbmemmbmbzuocnlbh',
                            region: 'us-east-1'
                        });

                        console.log('Nhost initialized successfully');

                        // Check for existing session
                        const session = nhost.auth.getSession();

                        if (session) {
                            currentUser = session.user;
                            if (currentUser.email === ADMIN_EMAIL) {
                                currentUser.roles = ['admin'];
                            }
                            window.updateUIForLoggedInUser();
                            await window.loadUserProfile();
                        }

                        initResolve();
                        window.showToast('App ready', 'success');
                        window.showHome();

                    } catch (nhostError) {
                        console.error('Nhost initialization error:', nhostError);
                        setupDemoMode();
                    }
                } else {
                    console.error('Nhost SDK not found');
                    setupDemoMode();
                }
            } catch (error) {
                console.error('Failed to initialize app:', error);
                setupDemoMode();
            }
        }

        // Setup demo mode for testing
        function setupDemoMode() {
            console.log('Setting up demo mode');
            window.showToast('Running in demo mode - some features may be limited', 'info');

            // Create a mock nhost object
            nhost = {
                auth: {
                    getSession: () => null,
                    signUp: async () => {
                        window.showToast('Demo: Registration successful!', 'success');
                        return { error: null };
                    },
                    signIn: async () => {
                        window.showToast('Demo: Login successful!', 'success');
                        return { error: null };
                    },
                    signOut: () => {
                        console.log('Demo: Logout');
                    },
                    resetPassword: async () => {
                        window.showToast('Demo: Password reset email sent!', 'success');
                        return { error: null };
                    }
                }
            };

            initResolve();
        }

        // Attach all functions to window object
        window.showToast = function(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        window.filterCountries = function(search) {
            const filtered = COUNTRIES.filter(c => c.toLowerCase().includes(search.toLowerCase()));
            const suggestions = document.getElementById('countrySuggestions');
            suggestions.innerHTML = filtered.map(c => `<div class="suggestion-item" onclick="window.selectCountry('${c}')">${c}</div>`).join('');
            suggestions.classList.add('active');
        };

        window.selectCountry = function(country) {
            document.getElementById('regCountry').value = country;
            document.getElementById('countrySuggestions').classList.remove('active');
        };

        window.filterEditCountries = function(search) {
            const filtered = COUNTRIES.filter(c => c.toLowerCase().includes(search.toLowerCase()));
            const suggestions = document.getElementById('editCountrySuggestions');
            suggestions.innerHTML = filtered.map(c => `<div class="suggestion-item" onclick="window.selectEditCountry('${c}')">${c}</div>`).join('');
            suggestions.classList.add('active');
        };

        window.selectEditCountry = function(country) {
            document.getElementById('editCountry').value = country;
            document.getElementById('editCountrySuggestions').classList.remove('active');
        };

        window.showHome = function() {
            if (currentUser) {
                document.getElementById('heroSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('profilePage').style.display = 'none';
                document.getElementById('backButton').style.display = 'none';
                window.startOnlineCounter();
            } else {
                document.getElementById('heroSection').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
            }
        };

        window.showFreePlay = function() {
            if (!currentUser) { window.showLoginModal(); return; }
            window.switchMode('freeplay');
        };

        window.showLeagues = function() {
            if (!currentUser) { window.showLoginModal(); return; }
            window.switchMode('league');
        };

        window.showLeaderboard = function() {
            if (!currentUser) { window.showLoginModal(); return; }
            window.switchMode('freeplay');
            // Wait for DOM update and scroll to leaderboard
            setTimeout(() => {
                const leaderboard = document.querySelector('#freeplaySection .leaderboard-table');
                if (leaderboard) {
                    leaderboard.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
        };

        window.showProfile = function() {
            if (!currentUser) { window.showLoginModal(); return; }
            document.getElementById('profilePage').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('heroSection').style.display = 'none';
            document.getElementById('backButton').style.display = 'inline-flex';
            window.loadProfileData();
        };

        window.showDashboard = function() {
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('backButton').style.display = 'none';
        };

        window.showLoginModal = function() {
            document.getElementById('loginModal').classList.add('active');
        };

        window.showRegisterModal = function() {
            document.getElementById('registerModal').classList.add('active');
        };

        window.showForgotPasswordModal = function() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('forgotPasswordModal').classList.add('active');
        };

        window.closeModal = function(id) {
            document.getElementById(id).classList.remove('active');
        };

        window.switchToRegister = function() {
            window.closeModal('loginModal');
            window.closeModal('forgotPasswordModal');
            window.showRegisterModal();
        };

        window.switchToLogin = function() {
            window.closeModal('registerModal');
            window.closeModal('forgotPasswordModal');
            window.showLoginModal();
        };

        window.handleForgotPassword = async function(event) {
            event.preventDefault();

            const email = document.getElementById('forgotEmail').value;

            try {
                const nhost = await ensureNhost();
                const { error } = await nhost.auth.resetPassword({
                    email,
                    options: { redirectTo: window.location.origin }
                });

                if (error) throw error;

                window.showToast('Password reset link sent to your email!', 'success');
                window.closeModal('forgotPasswordModal');
                window.showLoginModal();
            } catch (error) {
                window.showToast(error.message, 'error');
            }
        };

        window.handleRegister = async function(event) {
            event.preventDefault();

            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            const country = document.getElementById('regCountry').value;
            const efootballUser = document.getElementById('regEfootball').value;

            try {
                const nhost = await ensureNhost();
                const { error } = await nhost.auth.signUp({
                    email,
                    password,
                    options: {
                        displayName: name,
                        redirectTo: window.location.origin,
                        metadata: {
                            country,
                            efootballUser
                        }
                    }
                });

                if (error) throw error;

                window.showToast('Registration successful! Please check your email for verification.', 'success');
                window.closeModal('registerModal');
                window.showLoginModal();
            } catch (error) {
                window.showToast(error.message, 'error');
            }
        };

        window.handleLogin = async function(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const nhost = await ensureNhost();
                const { error } = await nhost.auth.signIn({ email, password });
                if (error) throw error;

                const session = nhost.auth.getSession();
                currentUser = session?.user;

                // Check if user is admin
                if (currentUser.email === ADMIN_EMAIL) {
                    currentUser.roles = ['admin'];
                }

                window.updateUIForLoggedInUser();
                await window.loadUserProfile();

                window.showToast('Login successful!', 'success');
                window.closeModal('loginModal');
                window.showHome();
            } catch (error) {
                window.showToast(error.message, 'error');
            }
        };

        window.logout = function() {
            try {
                ensureNhost().then(nhost => {
                    nhost.auth.signOut();
                    currentUser = null;
                    window.updateUIForLoggedOutUser();
                    window.showHome();
                    window.showToast('Logged out', 'info');
                }).catch(() => {
                    // Even if nhost fails, we can still logout locally
                    currentUser = null;
                    window.updateUIForLoggedOutUser();
                    window.showHome();
                    window.showToast('Logged out', 'info');
                });
            } catch (error) {
                window.showToast(error.message, 'error');
            }
        };

        window.updateUIForLoggedInUser = function() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('registerBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('mobileLoginBtn').style.display = 'none';
            document.getElementById('mobileRegisterBtn').style.display = 'none';
            document.getElementById('mobileLogoutBtn').style.display = 'block';

            if (currentUser?.email === ADMIN_EMAIL) {
                document.getElementById('adminBtn').style.display = 'inline-block';
            }
        };

        window.updateUIForLoggedOutUser = function() {
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('registerBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('adminBtn').style.display = 'none';
            document.getElementById('mobileLoginBtn').style.display = 'block';
            document.getElementById('mobileRegisterBtn').style.display = 'block';
            document.getElementById('mobileLogoutBtn').style.display = 'none';
        };

        window.loadUserProfile = async function() {
            if (!currentUser) return;

            try {
                // Use displayName from Nhost user object
                document.getElementById('playerName').textContent = currentUser.displayName || currentUser.email.split('@')[0];

                // You could also fetch more detailed profile data here via GraphQL if needed
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        };

        window.loadProfileData = function() {
            if (currentUser) {
                document.getElementById('profileName').textContent = currentUser.displayName || 'N/A';
                document.getElementById('profileCountry').textContent = currentUser.metadata?.country || 'N/A';
                document.getElementById('profileEfootball').textContent = currentUser.metadata?.efootballUser || 'N/A';
                document.getElementById('profileLeague').textContent = currentUser.metadata?.league || 'None';
            }
        };

        window.startOnlineCounter = function() {
            if (onlineInterval) clearInterval(onlineInterval);

            onlineInterval = setInterval(async () => {
                // In demo mode, show random number
                onlineUsers = Math.floor(Math.random() * 50) + 10;
                document.getElementById('onlineCounter').innerHTML = `
                    <span class="online-dot"></span>
                    <span>${onlineUsers} players online</span>
                `;
            }, 30000);

            // Set initial value
            onlineUsers = Math.floor(Math.random() * 50) + 10;
            document.getElementById('onlineCounter').innerHTML = `
                <span class="online-dot"></span>
                <span>${onlineUsers} players online</span>
            `;
        };

        window.switchMode = function(mode) {
            if (mode === 'freeplay') {
                document.getElementById('freeplaySection').style.display = 'block';
                document.getElementById('leagueSection').style.display = 'none';
                document.getElementById('freeplayMode').classList.add('active');
                document.getElementById('leagueMode').classList.remove('active');
            } else {
                document.getElementById('freeplaySection').style.display = 'none';
                document.getElementById('leagueSection').style.display = 'block';
                document.getElementById('leagueMode').classList.add('active');
                document.getElementById('freeplayMode').classList.remove('active');
            }
        };

        window.findOpponent = function() {
            window.showToast('Searching for opponents...', 'info');
        };

        window.submitResult = function(e) {
            e.preventDefault();
            window.showToast('Result submitted', 'success');
        };

        window.sendMessage = function() {
            window.showToast('Message sent', 'info');
        };

        window.closeChat = function() {
            document.getElementById('chatContainer').classList.remove('active');
        };

        window.toggleMobileMenu = function() {
            document.getElementById('mobileNav').classList.toggle('active');
        };

        window.goBack = function() {
            window.showDashboard();
        };

        window.showEditProfile = function() {
            document.getElementById('editProfileModal').classList.add('active');
            if (currentUser) {
                document.getElementById('editName').value = currentUser.displayName || '';
                document.getElementById('editCountry').value = currentUser.metadata?.country || '';
                document.getElementById('editEfootball').value = currentUser.metadata?.efootballUser || '';
            }
        };

        window.updateProfile = async function(e) {
            e.preventDefault();

            const displayName = document.getElementById('editName').value;
            const country = document.getElementById('editCountry').value;
            const efootballUser = document.getElementById('editEfootball').value;

            try {
                const nhost = await ensureNhost();
                const { error } = await nhost.auth.updateUser({
                    displayName,
                    metadata: {
                        ...currentUser.metadata,
                        country,
                        efootballUser
                    }
                });

                if (error) throw error;

                // Update local current user
                currentUser.displayName = displayName;
                currentUser.metadata = { ...currentUser.metadata, country, efootballUser };

                window.loadProfileData();
                window.loadUserProfile();

                window.showToast('Profile updated', 'success');
                window.closeModal('editProfileModal');
            } catch (error) {
                window.showToast(error.message, 'error');
            }
        };

        window.showAdminModal = function() {
            window.showToast('Admin functions coming soon', 'info');
        };

        // Start the app
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
