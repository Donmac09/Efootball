<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donmac Efootball - Professional Gaming Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0f1e 0%, #1a1f30 100%);
            min-height: 100vh;
            color: #ffffff;
        }

        .navbar {
            background: rgba(10, 15, 30, 0.98);
            padding: 1rem 5%;
            box-shadow: 0 2px 20px rgba(0, 212, 255, 0.3);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #00d4ff;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #00d4ff;
        }

        .btn {
            padding: 0.6rem 1.8rem;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #00d4ff;
            color: #00d4ff;
        }

        .btn-secondary:hover {
            background: #00d4ff;
            color: #0a0f1e;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #0a0f1e;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 5%;
            margin-top: 80px;
        }

        .hero {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .hero-content h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-content p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: #b0b0b0;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .welcome-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 25px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card h3 {
            color: #b0b0b0;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2.5rem;
            color: #00d4ff;
            font-weight: bold;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: 2px solid #00d4ff;
            color: #00d4ff;
            font-size: 1.5rem;
            padding: 0.2rem 0.6rem;
            border-radius: 8px;
            cursor: pointer;
        }

        .mode-selection {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            flex: 1;
            max-width: 300px;
            transition: all 0.3s;
        }

        .mode-card:hover {
            border-color: #00d4ff;
            transform: translateY(-5px);
            background: rgba(0, 212, 255, 0.15);
        }

        .mode-card.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.2);
        }

        .mode-card h3 {
            color: #00d4ff;
            margin-bottom: 0.5rem;
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .match-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
        }

        .match-card h3 {
            color: #00d4ff;
            margin-bottom: 0.5rem;
        }

        .match-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .match-actions button {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: #1a1f30;
            border: 2px solid #00d4ff;
            border-radius: 20px;
            display: none;
            z-index: 2000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .chat-container.active {
            display: block;
        }

        .chat-header {
            padding: 1rem;
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            color: white;
            border-radius: 18px 18px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .chat-header button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.8rem;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.sent {
            background: #00d4ff;
            color: #0a0f1e;
            margin-left: auto;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .message small {
            display: block;
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.3rem;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            gap: 0.5rem;
        }

        .chat-input input {
            flex: 1;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .chat-input button {
            padding: 0.8rem 1.5rem;
            background: #00d4ff;
            border: none;
            border-radius: 10px;
            color: #0a0f1e;
            font-weight: bold;
            cursor: pointer;
        }

        .chat-input button:hover {
            background: #00b8e6;
        }

        .league-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .league-card {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
        }

        .league-card:hover {
            border-color: #00d4ff;
            transform: translateY(-5px);
        }

        .league-card h3 {
            color: #00d4ff;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }

        .league-card .teams {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 1rem 0;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1f30;
            border: 2px solid #00d4ff;
            border-radius: 25px;
            padding: 2.5rem;
            max-width: 1000px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 212, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-header h2 {
            color: #00d4ff;
            font-size: 1.8rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #00d4ff;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #00d4ff;
            font-weight: 500;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-group select option {
            background: #1a1f30;
            color: white;
        }

        .country-search {
            margin-bottom: 0.5rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            margin-bottom: 0.5rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .country-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00d4ff;
            border-radius: 12px;
            display: none;
            position: absolute;
            width: 90%;
            z-index: 100;
        }

        .country-list.active {
            display: block;
        }

        .country-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: background 0.3s;
            color: white;
        }

        .country-item:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .leaderboard-table th {
            background: rgba(0, 212, 255, 0.2);
            padding: 1rem;
            text-align: left;
            color: white;
            font-weight: 600;
        }

        .leaderboard-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), transparent);
        }

        .rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.2), transparent);
        }

        .rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.2), transparent);
        }

        .winner-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .winner-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(157, 78, 221, 0.2));
            border: 2px solid #00d4ff;
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
        }

        .winner-card h3 {
            color: #00d4ff;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 1rem;
            margin-top: 1rem;
        }

        .podium-place {
            text-align: center;
            flex: 1;
        }

        .podium-1 { order: 2; }
        .podium-2 { order: 1; }
        .podium-3 { order: 3; }

        .podium-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid;
            border-radius: 15px;
            padding: 1rem;
        }

        .podium-1 .podium-card {
            border-color: gold;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), transparent);
            transform: scale(1.1);
        }

        .podium-2 .podium-card {
            border-color: silver;
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), transparent);
        }

        .podium-3 .podium-card {
            border-color: #cd7f32;
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), transparent);
        }

        .podium-rank {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .podium-1 .podium-rank { color: gold; }
        .podium-2 .podium-rank { color: silver; }
        .podium-3 .podium-rank { color: #cd7f32; }

        .tab-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 0.8rem 2rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .tab-button.active {
            background: #00d4ff;
            color: #0a0f1e;
            border-color: #00d4ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .admin-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .admin-controls button {
            padding: 0.3rem 0.8rem;
            font-size: 0.85rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid #28a745;
        }

        .status-suspended {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .status-blocked {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .ai-badge {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 30px;
            padding: 0.5rem 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #00d4ff;
            font-weight: 600;
            margin: 1rem 0;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1a1f30;
            border-left: 4px solid #00d4ff;
            border-radius: 10px;
            padding: 1rem 2rem;
            color: white;
            animation: slideIn 0.3s ease;
            z-index: 4000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .toast.success { border-left-color: #28a745; }
        .toast.error { border-left-color: #dc3545; }
        .toast.warning { border-left-color: #ffc107; }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .mode-selection {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-card {
                width: 100%;
            }
            
            .chat-container {
                width: 100%;
                bottom: 0;
                right: 0;
                border-radius: 20px 20px 0 0;
            }
            
            .podium {
                flex-direction: column;
                align-items: center;
            }
            
            .podium-card {
                width: 100%;
            }
            
            .leaderboard-table {
                font-size: 0.85rem;
            }
            
            .leaderboard-table th,
            .leaderboard-table td {
                padding: 0.5rem;
            }

            .mobile-menu-btn {
                display: block;
            }

            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 70px;
                left: 0;
                width: 100%;
                background: rgba(10, 15, 30, 0.98);
                padding: 2rem;
                gap: 1.5rem;
                border-bottom: 2px solid #00d4ff;
                box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            }

            .nav-links.active {
                display: flex;
            }

            .nav-links button {
                width: 100%;
                margin-left: 0 !important;
            }
        }

    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <span class="logo" onclick="showHome()">Donmac Efootball</span>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
        <div class="nav-links" id="navLinks">
            <a onclick="showHome()">Home</a>
            <a onclick="showFreePlay()">Free Play</a>
            <a onclick="showLeagues()">Leagues</a>
            <a onclick="showLeaderboard()">Leaderboard</a>
            <a onclick="showProfile()">Profile</a>
            <button class="btn btn-primary" id="loginBtn" onclick="showLoginModal()">Login</button>
            <button class="btn btn-secondary" id="registerBtn" onclick="showRegisterModal()">Register</button>
            <button class="btn btn-secondary" id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
            <button class="btn btn-primary" id="adminBtn" onclick="showAdminModal()" style="display: none; margin-left: 1rem;">Admin Panel</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container" id="mainContent">
        <!-- Hero Section -->
        <div id="heroSection" class="hero">
            <div class="hero-content">
                <h1>Welcome to Donmac Efootball</h1>
                <p>Join competitive leagues or play friendly matches. Climb the ranks and become a champion!</p>
                <button class="btn btn-primary" onclick="showRegisterModal()">Get Started</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="welcome-card">
                <h2>Welcome, <span id="playerName"></span>!</h2>
                <p id="playerStatus" style="color: #b0b0b0;"></p>
            </div>

            <!-- Phase Winners Display -->
            <div class="winner-section">
                <div class="winner-card">
                    <h3>üèÜ Current Free Play Phase</h3>
                    <div id="freePlayPhaseTop3"></div>
                </div>
                <div class="winner-card">
                    <h3>üèÜ League Champions</h3>
                    <div id="leagueChampions"></div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Free Play Points</h3>
                    <div class="value" id="freePlayPoints">0</div>
                </div>
                <div class="stat-card">
                    <h3>League Points</h3>
                    <div class="value" id="leaguePoints">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Matches</h3>
                    <div class="value" id="totalMatches">0</div>
                </div>
                <div class="stat-card">
                    <h3>Goal Difference</h3>
                    <div class="value" id="goalDifference">0</div>
                </div>
            </div>

            <!-- Mode Selection -->
            <div class="mode-selection">
                <div class="mode-card" onclick="switchMode('freeplay')" id="freeplayMode">
                    <h3>‚öΩ Free Play</h3>
                    <p>Casual matches, play anytime</p>
                </div>
                <div class="mode-card" onclick="switchMode('league')" id="leagueMode">
                    <h3>üèÜ League Mode</h3>
                    <p>Competitive league matches</p>
                </div>
            </div>

            <!-- Free Play Section -->
            <div id="freeplaySection">
                <div class="welcome-card">
                    <h3>Find Opponent</h3>
                    <button class="btn btn-primary" onclick="findOpponent()">üîç Search for Opponent</button>
                </div>

                <div class="welcome-card">
                    <h3>Your Active Matches</h3>
                    <div id="activeMatches"></div>
                </div>

                <!-- Free Play Leaderboard -->
                <div class="welcome-card">
                    <h3>Free Play Leaderboard</h3>
                    <table class="leaderboard-table" id="freePlayLeaderboard">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Country</th>
                                <th>P</th>
                                <th>W</th>
                                <th>D</th>
                                <th>L</th>
                                <th>GF</th>
                                <th>GA</th>
                                <th>GD</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody id="freePlayLeaderboardBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- League Section -->
            <div id="leagueSection" style="display: none;">
                <div class="welcome-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Available Leagues</h3>
                        <button class="btn btn-secondary" onclick="showHome()">‚Üê Back to Dashboard</button>
                    </div>
                    <div class="league-grid" id="leagueList"></div>
                </div>

                <!-- League Standings -->
                <div id="leagueStandings" style="display: none;">
                    <div class="welcome-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Your League Standings</h3>
                        </div>
                        <table class="leaderboard-table" id="leagueLeaderboard">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Country</th>
                                    <th>P</th>
                                    <th>W</th>
                                    <th>D</th>
                                    <th>L</th>
                                    <th>GF</th>
                                    <th>GA</th>
                                    <th>GD</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody id="leagueLeaderboardBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" style="display: none;">
            <div class="welcome-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Player Profile</h2>
                    <button class="btn btn-secondary" onclick="showHome()">‚Üê Back to Dashboard</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Name</h3>
                        <div class="value" id="profileName"></div>
                    </div>
                    <div class="stat-card">
                        <h3>Country</h3>
                        <div class="value" id="profileCountry"></div>
                    </div>
                    <div class="stat-card">
                        <h3>eFootball User</h3>
                        <div class="value" id="profileEfootball"></div>
                    </div>
                    <div class="stat-card">
                        <h3>League</h3>
                        <div class="value" id="profileLeague">Not in league</div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Free Play Stats</h3>
                        <div id="profileFreePlayStats"></div>
                    </div>
                    <div class="stat-card">
                        <h3>League Stats</h3>
                        <div id="profileLeagueStats"></div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="showEditProfile()" style="margin-top: 1rem;">Edit Profile</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Login to Donmac</h2>
                <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            <p style="text-align: center; margin-top: 1.5rem; color: #b0b0b0;">
                Don't have an account? 
                <a onclick="switchToRegister()" style="color: #00d4ff; cursor: pointer; text-decoration: none;">Register here</a>
            </p>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Create Account</h2>
                <button class="close-btn" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <form onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="regEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Choose a password" required>
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <div class="country-search">
                        <input type="text" class="search-input" id="countrySearch" placeholder="Enter or search your country..." onkeyup="filterCountries()" onclick="showCountryList()" required>
                        <div class="country-list" id="countryList"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>eFootball Username</label>
                    <input type="text" id="regEfootball" placeholder="Your in-game username" required>
                </div>
                <p style="color: #b0b0b0; margin: 1rem 0;">You can join a league later from the Leagues section.</p>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
            </form>
            <p style="text-align: center; margin-top: 1.5rem; color: #b0b0b0;">
                Already have an account? 
                <a onclick="switchToLogin()" style="color: #00d4ff; cursor: pointer; text-decoration: none;">Login here</a>
            </p>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal" id="resultModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Submit Match Result</h2>
                <button class="close-btn" onclick="closeModal('resultModal')">&times;</button>
            </div>
            <form onsubmit="submitResult(event)">
                <div class="form-group">
                    <label>Match ID</label>
                    <input type="text" id="resultMatchId" readonly style="background: rgba(255,255,255,0.05);">
                </div>
                
                <div class="form-group">
                    <label>Opponent</label>
                    <input type="text" id="resultOpponent" readonly style="background: rgba(255,255,255,0.05);">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Your Score</label>
                        <input type="number" id="yourScore" min="0" max="20" placeholder="Goals" required>
                    </div>
                    <div class="form-group">
                        <label>Opponent Score</label>
                        <input type="number" id="opponentScore" min="0" max="20" placeholder="Goals" required>
                    </div>
                </div>

                <div class="ai-badge">
                    <span>ü§ñ AI VERIFICATION ACTIVE</span>
                </div>

                <div class="form-group">
                    <label>Match Result Screenshot</label>
                    <input type="file" id="matchScreenshot" accept="image/*" required>
                    <small style="color: #b0b0b0;">Upload a clear screenshot of the final match result</small>
                </div>

                <div class="form-group">
                    <label>Match Video (Optional)</label>
                    <input type="file" id="matchVideo" accept="video/*">
                    <small style="color: #b0b0b0;">Upload video evidence if available</small>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Submit for AI Verification</button>
            </form>
        </div>
    </div>

    <!-- Admin Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Admin Dashboard</h2>
                <button class="close-btn" onclick="closeModal('adminModal')">&times;</button>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchAdminTab('players')">Players</button>
                <button class="tab-button" onclick="switchAdminTab('matches')">Matches</button>
                <button class="tab-button" onclick="switchAdminTab('leagues')">Leagues</button>
                <button class="tab-button" onclick="switchAdminTab('phases')">Phases</button>
                <button class="tab-button" onclick="switchAdminTab('points')">Deduct Points</button>
            </div>

            <!-- Players Tab -->
            <div id="adminPlayersTab" class="tab-content active">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Country</th>
                            <th>Status</th>
                            <th>Free Pts</th>
                            <th>League Pts</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminPlayersBody"></tbody>
                </table>
            </div>

            <!-- Matches Tab -->
            <div id="adminMatchesTab" class="tab-content">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Match ID</th>
                            <th>Players</th>
                            <th>Result</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminMatchesBody"></tbody>
                </table>
            </div>

            <!-- Leagues Tab -->
            <div id="adminLeaguesTab" class="tab-content">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>League</th>
                            <th>Players</th>
                            <th>Status</th>
                            <th>Current Leader</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminLeaguesBody"></tbody>
                </table>
            </div>

            <!-- Phases Tab -->
            <div id="adminPhasesTab" class="tab-content">
                <div class="form-group">
                    <label>Current Free Play Phase</label>
                    <input type="text" id="currentPhase" value="Phase 1" readonly style="background: rgba(255,255,255,0.05);">
                </div>
                
                <div style="margin: 2rem 0;">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Previous Phase Winners</h3>
                    <div id="phaseWinnersList"></div>
                </div>

                <button class="btn btn-primary" onclick="endFreePlayPhase()">End Current Phase & Declare Winners</button>
                <button class="btn btn-secondary" onclick="resetAllPhases()" style="margin-left: 1rem;">Reset All Phases</button>
            </div>

            <!-- Deduct Points Tab -->
            <div id="adminPointsTab" class="tab-content">
                <div class="form-group">
                    <label>Select Player</label>
                    <select id="pointsPlayerSelect" onchange="loadPlayerForDeduction()">
                        <option value="">Choose a player...</option>
                    </select>
                </div>

                <div id="deductionForm" style="display: none;">
                    <div class="form-group">
                        <label>Player Name</label>
                        <input type="text" id="pointsPlayerName" readonly style="background: rgba(255,255,255,0.05);">
                    </div>
                    <div class="form-group">
                        <label>Current Free Play Points</label>
                        <input type="text" id="pointsCurrentFree" readonly style="background: rgba(255,255,255,0.05);">
                    </div>
                    <div class="form-group">
                        <label>Current League Points</label>
                        <input type="text" id="pointsCurrentLeague" readonly style="background: rgba(255,255,255,0.05);">
                    </div>
                    <div class="form-group">
                        <label>Points Type</label>
                        <select id="pointsType">
                            <option value="free">Free Play Points</option>
                            <option value="league">League Points</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount to Deduct</label>
                        <input type="number" id="pointsAmount" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Reason for Deduction</label>
                        <textarea id="pointsReason" rows="3" placeholder="Enter reason..." required></textarea>
                    </div>
                    <button class="btn btn-danger" onclick="deductPoints()">Deduct Points</button>
                </div>
            </div>

            <div style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('adminModal')">Close Admin Dashboard</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="close-btn" onclick="closeModal('editProfileModal')">&times;</button>
            </div>
            <form onsubmit="updateProfile(event)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <div class="country-search">
                        <input type="text" class="search-input" id="editCountrySearch" placeholder="Enter or search your country..." onkeyup="filterEditCountries()" onclick="showEditCountryList()" required>
                        <div class="country-list" id="editCountryList"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>eFootball Username</label>
                    <input type="text" id="editEfootball" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Update Profile</button>
            </form>
        </div>
    </div>

    <!-- Deduct Points Modal (Legacy) -->
    <div class="modal" id="deductPointsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Deduct Points</h2>
                <button class="close-btn" onclick="closeModal('deductPointsModal')">&times;</button>
            </div>
            <form onsubmit="deductPointsFromModal(event)">
                <input type="hidden" id="deductPlayerId">
                <div class="form-group">
                    <label>Player</label>
                    <input type="text" id="deductPlayerName" readonly>
                </div>
                <div class="form-group">
                    <label>Points to Deduct</label>
                    <input type="number" id="deductAmount" min="1" required>
                </div>
                <div class="form-group">
                    <label>Reason</label>
                    <textarea id="deductReason" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-danger" style="width: 100%;">Deduct Points</button>
            </form>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <span>üí¨ Chat with <span id="chatOpponent"></span></span>
            <button onclick="closeChat()">‚úï</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // UI Navigation functions (non-module to ensure responsiveness even if SDK is loading)
        window.toggleMobileMenu = function() {
            const navLinks = document.getElementById('navLinks');
            if (navLinks) navLinks.classList.toggle('active');
        };

        window.closeMobileMenu = function() {
            const navLinks = document.getElementById('navLinks');
            if (navLinks) navLinks.classList.remove('active');
        };

        window.showSection = function(sectionId) {
            window.closeMobileMenu();
            const sections = ['heroSection', 'dashboard', 'profilePage'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('active');
                    if (id !== 'dashboard') element.style.display = 'none';
                }
            });

            if (sectionId === 'dashboard') {
                const target = document.getElementById('dashboard');
                if (target) target.classList.add('active');
            } else {
                const target = document.getElementById(sectionId);
                if (target) {
                    target.style.display = (sectionId === 'heroSection') ? 'flex' : 'block';
                }
            }
        };

        window.showHome = () => {
            if (window.currentUser) {
                window.showSection('dashboard');
                if (window.switchMode) window.switchMode('freeplay');
            } else {
                window.showSection('heroSection');
            }
        };

        window.showFreePlay = () => {
            if (!window.currentUser) {
                if (window.showToast) window.showToast('Please login first', 'warning');
                window.showLoginModal();
                return;
            }
            window.showSection('dashboard');
            if (window.switchMode) window.switchMode('freeplay');
        };

        window.showLeagues = () => {
            if (!window.currentUser) {
                if (window.showToast) window.showToast('Please login first', 'warning');
                window.showLoginModal();
                return;
            }
            window.showSection('dashboard');
            if (window.switchMode) window.switchMode('league');
        };

        window.showProfile = () => {
            if (!window.currentUser) {
                if (window.showToast) window.showToast('Please login first', 'warning');
                window.showLoginModal();
                return;
            }
            window.showSection('profilePage');
            if (window.updateProfileDisplay) window.updateProfileDisplay();
        };

        window.showLoginModal = function() {
            window.closeMobileMenu();
            const modal = document.getElementById('loginModal');
            if (modal) modal.classList.add('active');
        };

        window.showRegisterModal = function() {
            window.closeMobileMenu();
            const modal = document.getElementById('registerModal');
            if (modal) modal.classList.add('active');
            if (window.populateCountries) window.populateCountries();
        };

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        };

        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
    </script>

    <script type="module">
        import { NhostClient } from 'https://cdn.jsdelivr.net/npm/@nhost/nhost-js@2.1.1/+esm';

        const nhost = new NhostClient({
            subdomain: 'kodpbmemmbmbzuocnlbh',
            region: 'us-east-1'
        });

        window.nhost = nhost;

        async function graphql(query, variables = {}) {
            const { data, error } = await nhost.graphql.request(query, variables);
            if (error) {
                console.error('GraphQL Error:', error);
                throw error;
            }
            return data;
        }

        // All countries that play eFootball
        const COUNTRIES = [
            "Argentina", "Australia", "Austria", "Belgium", "Brazil", "Bulgaria", "Canada", 
            "Chile", "China", "Colombia", "Costa Rica", "Croatia", "Czech Republic", "Denmark", 
            "Ecuador", "Egypt", "England", "Finland", "France", "Germany", "Ghana", "Greece", 
            "Hungary", "Iceland", "India", "Indonesia", "Iran", "Ireland", "Israel", "Italy", 
            "Ivory Coast", "Japan", "Kazakhstan", "Kenya", "Malaysia", "Mexico", "Morocco", 
            "Netherlands", "New Zealand", "Nigeria", "Norway", "Peru", "Philippines", "Poland", 
            "Portugal", "Qatar", "Romania", "Russia", "Saudi Arabia", "Scotland", "Senegal", 
            "Serbia", "Singapore", "Slovakia", "Slovenia", "South Africa", "South Korea", "Spain", 
            "Sweden", "Switzerland", "Thailand", "Tunisia", "Turkey", "Ukraine", "United Arab Emirates", 
            "United Kingdom", "United States", "Uruguay", "Venezuela", "Vietnam", "Wales", "Zimbabwe"
        ];

        // League configurations
        const LEAGUES = {
            EPL: { name: 'English Premier League', teams: 20 },
            LaLiga: { name: 'Spanish La Liga', teams: 20 },
            SerieA: { name: 'Italian Serie A', teams: 20 },
            Bundesliga: { name: 'German Bundesliga', teams: 18 },
            Ligue1: { name: 'French Ligue 1', teams: 18 }
        };

        // State
        let currentUser = null;
        window.currentUser = null;

        nhost.auth.onAuthStateChanged((event, session) => {
            if (session) {
                currentUser = {
                    ...session.user,
                    name: session.user.displayName,
                    ...session.user.metadata
                };
                window.currentUser = currentUser;

                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('registerBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';

                // For this implementation, we'll check admin by email
                const adminEmails = ['donmacdatahub@gmail.com', 'donmacadmin@efootball.com'];
                if (adminEmails.includes(currentUser.email)) {
                    document.getElementById('adminBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('adminBtn').style.display = 'none';
                }

                document.getElementById('playerName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('playerStatus').textContent = currentUser.metadata?.league ?
                    `Currently in ${LEAGUES[currentUser.metadata.league].name}` : 'Not in any league';

                updateStats();
                loadActiveMatches();
                updateFreePlayLeaderboard();
                updatePhaseWinnersDisplay();

                showHome();
            } else {
                currentUser = null;
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('registerBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('adminBtn').style.display = 'none';

                showHome();
            }
        });

        let currentChatMatch = null;

        // Initialize admin (No longer needed with Nhost Auth)
        function initializeAdmin() {}

        // Populate country lists
        function populateCountries() {
            const countryList = document.getElementById('countryList');
            const editCountryList = document.getElementById('editCountryList');
            
            if (countryList) {
                countryList.innerHTML = COUNTRIES.map(country => 
                    `<div class="country-item" onclick="selectCountry('${country}')">${country}</div>`
                ).join('');
            }
            
            if (editCountryList) {
                editCountryList.innerHTML = COUNTRIES.map(country => 
                    `<div class="country-item" onclick="selectEditCountry('${country}')">${country}</div>`
                ).join('');
            }
        }

        function filterCountries() {
            const search = document.getElementById('countrySearch').value.toLowerCase();
            const filtered = COUNTRIES.filter(c => c.toLowerCase().includes(search));
            const countryList = document.getElementById('countryList');
            
            countryList.innerHTML = filtered.map(country => 
                `<div class="country-item" onclick="selectCountry('${country}')">${country}</div>`
            ).join('');
            
            countryList.classList.add('active');
        }

        function filterEditCountries() {
            const search = document.getElementById('editCountrySearch').value.toLowerCase();
            const filtered = COUNTRIES.filter(c => c.toLowerCase().includes(search));
            const countryList = document.getElementById('editCountryList');
            
            countryList.innerHTML = filtered.map(country => 
                `<div class="country-item" onclick="selectEditCountry('${country}')">${country}</div>`
            ).join('');
            
            countryList.classList.add('active');
        }

        function showCountryList() {
            document.getElementById('countryList').classList.add('active');
        }

        function showEditCountryList() {
            document.getElementById('editCountryList').classList.add('active');
        }

        function selectCountry(country) {
            document.getElementById('countrySearch').value = country;
            document.getElementById('countryList').classList.remove('active');
        }

        function selectEditCountry(country) {
            document.getElementById('editCountrySearch').value = country;
            document.getElementById('editCountryList').classList.remove('active');
        }

        // AI Image Analysis
        async function analyzeScreenshot(imageFile) {
            let existingHashes = [];
            try {
                const { submitted_screenshots } = await graphql(`query { submitted_screenshots { hash } }`);
                existingHashes = submitted_screenshots.map(s => s.hash);
            } catch (err) {
                console.warn('Could not fetch existing screenshots from Nhost');
            }

            return new Promise((resolve) => {
                setTimeout(() => {
                    const fileReader = new FileReader();
                    fileReader.onload = function(e) {
                        const content = e.target.result;
                        let hash = 0;
                        for (let i = 0; i < Math.min(content.length, 1000); i++) {
                            hash = ((hash << 5) - hash) + content.charCodeAt(i);
                            hash = hash & hash;
                        }
                        const imageHash = hash.toString();
                        
                        const isDuplicate = existingHashes.includes(imageHash);
                        
                        // Simulate extracting scores from screenshot
                        const extractedScores = {
                            homeScore: Math.floor(Math.random() * 6),
                            awayScore: Math.floor(Math.random() * 6)
                        };
                        
                        resolve({
                            hash: imageHash,
                            isDuplicate: isDuplicate,
                            extractedScores: extractedScores,
                            isManipulated: Math.random() < 0.05
                        });
                    };
                    fileReader.readAsDataURL(imageFile);
                }, 1000);
            });
        }

        // AI Verification System
        class AIVerifier {
            async verifyResult(match, submittedScore, opponentScore, screenshot) {
                const issues = [];
                const warnings = [];

                // Check for duplicate screenshots
                const screenshotAnalysis = await analyzeScreenshot(screenshot);
                
                if (screenshotAnalysis.isDuplicate) {
                    issues.push('This screenshot has been used before');
                }

                if (screenshotAnalysis.isManipulated) {
                    issues.push('Screenshot appears to be edited');
                }

                // Verify scores match screenshot
                const extractedHomeScore = match.player1 === currentUser.id ? 
                    screenshotAnalysis.extractedScores.homeScore : screenshotAnalysis.extractedScores.awayScore;
                const extractedAwayScore = match.player1 === currentUser.id ? 
                    screenshotAnalysis.extractedScores.awayScore : screenshotAnalysis.extractedScores.homeScore;

                if (extractedHomeScore !== submittedScore || extractedAwayScore !== opponentScore) {
                    issues.push('Scores do not match the screenshot');
                }

                // Check for unrealistic scores
                if (submittedScore > 15 || opponentScore > 15) {
                    warnings.push('Unusually high score');
                }

                return {
                    verified: issues.length === 0,
                    issues: issues,
                    warnings: warnings,
                    screenshotHash: screenshotAnalysis.hash
                };
            }
        }

        const aiVerifier = new AIVerifier();

        // Navigation Functions
        function toggleMobileMenu() {
            document.getElementById('navLinks').classList.toggle('active');
        }

        function closeMobileMenu() {
            document.getElementById('navLinks').classList.remove('active');
        }

        function showHome() {
            closeMobileMenu();
            if (currentUser) {
                document.getElementById('heroSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('profilePage').style.display = 'none';
                switchMode('freeplay');
            } else {
                document.getElementById('heroSection').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('profilePage').style.display = 'none';
            }
        }

        function showFreePlay() {
            closeMobileMenu();
            if (!currentUser) {
                showToast('Please login first', 'warning');
                showLoginModal();
                return;
            }
            document.getElementById('heroSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('profilePage').style.display = 'none';
            switchMode('freeplay');
        }

        function showLeagues() {
            closeMobileMenu();
            if (!currentUser) {
                showToast('Please login first', 'warning');
                showLoginModal();
                return;
            }
            document.getElementById('heroSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('profilePage').style.display = 'none';
            switchMode('league');
        }

        function showLeaderboard() {
            closeMobileMenu();
            if (!currentUser) {
                showToast('Please login first', 'warning');
                showLoginModal();
                return;
            }
            showFullLeaderboard();
        }

        function updateProfileDisplay() {
            if (!window.currentUser) return;
            
            const m = window.currentUser.metadata || {};
            document.getElementById('profileName').textContent = currentUser.displayName || currentUser.email;
            document.getElementById('profileCountry').textContent = m.country || 'Not set';
            document.getElementById('profileEfootball').textContent = m.efootballUser || 'Not set';
            document.getElementById('profileLeague').textContent = m.league ? (LEAGUES[m.league]?.name || m.league) : 'Not in any league';
            
            // Profile stats
            document.getElementById('profileFreePlayStats').innerHTML = `
                <p>P: ${m.matchesPlayed || 0} | W: ${m.wins || 0} | D: ${m.draws || 0} | L: ${m.losses || 0}</p>
                <p>GF: ${m.goalsFor || 0} | GA: ${m.goalsAgainst || 0} | GD: ${(m.goalsFor || 0) - (m.goalsAgainst || 0)}</p>
                <p>Points: ${m.freePlayPoints || 0}</p>
            `;
            
            document.getElementById('profileLeagueStats').innerHTML = `
                <p>P: ${m.leagueMatchesPlayed || 0} | W: ${m.leagueWins || 0} | D: ${m.leagueDraws || 0} | L: ${m.leagueLosses || 0}</p>
                <p>GF: ${m.leagueGoalsFor || 0} | GA: ${m.leagueGoalsAgainst || 0} | GD: ${(m.leagueGoalsFor || 0) - (m.leagueGoalsAgainst || 0)}</p>
                <p>Points: ${m.leaguePoints || 0}</p>
            `;
        }

        function switchMode(mode) {
            document.getElementById('freeplayMode').classList.toggle('active', mode === 'freeplay');
            document.getElementById('leagueMode').classList.toggle('active', mode === 'league');
            
            document.getElementById('freeplaySection').style.display = mode === 'freeplay' ? 'block' : 'none';
            document.getElementById('leagueSection').style.display = mode === 'league' ? 'block' : 'none';
            
            if (mode === 'league') {
                loadLeagues();
                if (currentUser?.metadata?.league) {
                    document.getElementById('leagueStandings').style.display = 'block';
                    updateLeagueLeaderboard();
                } else {
                    document.getElementById('leagueStandings').style.display = 'none';
                }
            } else if (mode === 'freeplay') {
                loadActiveMatches();
                updateFreePlayLeaderboard();
            }
        }

        // Authentication Functions
        async function handleRegister(event) {
            event.preventDefault();

            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            const efootballUser = document.getElementById('regEfootball').value;
            const country = document.getElementById('countrySearch').value;

            if (!country) {
                showToast('Please enter your country', 'error');
                return;
            }

            const { session, error } = await nhost.auth.signUp({
                email,
                password,
                options: {
                    displayName: name,
                    metadata: {
                        country,
                        efootballUser,
                        league: null,
                        role: 'player',
                        status: 'active'
                    }
                }
            });

            if (error) {
                showToast(error.message, 'error');
            } else {
                showToast('Registration successful! Please login.', 'success');
                closeModal('registerModal');
                showLoginModal();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const { session, error } = await nhost.auth.signIn({ email, password });
            
            if (error) {
                showToast(error.message, 'error');
            } else {
                showToast(`Welcome back!`, 'success');
                closeModal('loginModal');
            }
        }

        async function logout() {
            closeMobileMenu();
            const { error } = await nhost.auth.signOut();
            if (error) {
                showToast(error.message, 'error');
            } else {
                currentChatMatch = null;
                document.getElementById('chatContainer').classList.remove('active');
                showToast('Logged out successfully', 'info');
            }
        }

        function updateStats() {
            if (!currentUser) return;
            const m = currentUser.metadata || {};

            document.getElementById('freePlayPoints').textContent = m.freePlayPoints || 0;
            document.getElementById('leaguePoints').textContent = m.leaguePoints || 0;
            document.getElementById('totalMatches').textContent = (m.matchesPlayed || 0) + (m.leagueMatchesPlayed || 0);
            
            const goalDifference = ((m.goalsFor || 0) - (m.goalsAgainst || 0)) +
                                 ((m.leagueGoalsFor || 0) - (m.leagueGoalsAgainst || 0));
            document.getElementById('goalDifference').textContent = goalDifference;
        }

        // Free Play Functions
        async function findOpponent() {
            showToast('Searching for opponents...', 'info');
            
            try {
                const queryUsers = `
                    query GetAvailablePlayers($currentUserId: uuid!) {
                        users(where: { id: { _neq: $currentUserId } }, limit: 10) {
                            id
                            displayName
                            metadata
                        }
                    }
                `;
                const { users } = await graphql(queryUsers, { currentUserId: currentUser.id });

                if (!users.length) {
                    showToast('No opponents available', 'warning');
                    return;
                }

                const opponent = users[Math.floor(Math.random() * users.length)];

                const mutation = `
                    mutation InsertMatch($player1Id: uuid!, $player2Id: uuid!, $type: String!) {
                        insert_matches_one(object: {
                            player1_id: $player1Id,
                            player2_id: $player2Id,
                            type: $type,
                            status: "pending"
                        }) {
                            id
                        }
                    }
                `;

                await graphql(mutation, {
                    player1Id: currentUser.id,
                    player2Id: opponent.id,
                    type: 'freeplay'
                });

                showToast(`Match found! Playing against ${opponent.metadata?.efootballUser || opponent.displayName}`, 'success');
                loadActiveMatches();
            } catch (err) {
                showToast('Failed to find opponent', 'error');
            }
        }

        async function loadActiveMatches() {
            if (!currentUser) return;

            try {
                const query = `
                    query GetActiveMatches($userId: uuid!) {
                        matches(where: {
                            _or: [
                                { player1_id: { _eq: $userId } },
                                { player2_id: { _eq: $userId } }
                            ],
                            status: { _eq: "pending" }
                        }) {
                            id
                            player1_id
                            player2_id
                            type
                            player1 { displayName metadata }
                            player2 { displayName metadata }
                        }
                    }
                `;
                const { matches: activeMatches } = await graphql(query, { userId: currentUser.id });

                const container = document.getElementById('activeMatches');

                if (activeMatches.length === 0) {
                    container.innerHTML = '<p style="color: #b0b0b0;">No active matches. Click "Search for Opponent" to start playing!</p>';
                    return;
                }

                container.innerHTML = '<div class="match-grid"></div>';
                const grid = container.querySelector('.match-grid');

                activeMatches.forEach(match => {
                    const isPlayer1 = match.player1_id === currentUser.id;
                    const opponent = isPlayer1 ? match.player2 : match.player1;
                    const opponentName = opponent?.metadata?.efootballUser || opponent?.displayName || 'Unknown';

                    const card = document.createElement('div');
                    card.className = 'match-card';
                    card.innerHTML = `
                        <h3>vs ${opponentName}</h3>
                        <p style="color: #b0b0b0;">Match ID: ${match.id}</p>
                        <div class="match-actions">
                            <button class="btn btn-primary" onclick="openResultModal('${match.id}')">Submit Result</button>
                            <button class="btn btn-secondary" onclick="openChat('${match.id}')">üí¨ Chat</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (err) {
                console.error('Failed to load active matches', err);
            }
        }

        // Free Play Leaderboard
        async function updateFreePlayLeaderboard() {
            try {
                const query = `
                    query GetLeaderboard {
                        free_play_leaderboard(order_by: {pts: desc, gd: desc, gf: desc}) {
                            player_name
                            country
                            p
                            w
                            d
                            l
                            gf
                            ga
                            gd
                            pts
                        }
                    }
                `;
                const { free_play_leaderboard } = await graphql(query);

                const tbody = document.getElementById('freePlayLeaderboardBody');
                tbody.innerHTML = free_play_leaderboard.map((player, index) => {
                    const rowClass = index < 3 ? `rank-${index + 1}` : '';
                    return `
                        <tr class="${rowClass}">
                            <td><strong>#${index + 1}</strong></td>
                            <td>${player.player_name}</td>
                            <td>${player.country || 'N/A'}</td>
                            <td>${player.p}</td>
                            <td>${player.w}</td>
                            <td>${player.d}</td>
                            <td>${player.l}</td>
                            <td>${player.gf}</td>
                            <td>${player.ga}</td>
                            <td>${player.gd}</td>
                            <td><strong style="color: #00d4ff;">${player.pts}</strong></td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error('Failed to update leaderboard', err);
            }
        }

        // League Functions
        async function loadLeagues() {
            try {
                const query = `
                    query GetLeagues {
                        leagues {
                            code
                            name
                            teams_limit
                        }
                        users {
                            metadata
                        }
                    }
                `;
                const { leagues, users } = await graphql(query);

                const leagueList = document.getElementById('leagueList');
                leagueList.innerHTML = '';

                leagues.forEach(league => {
                    const leaguePlayers = users.filter(u => u.metadata?.league === league.code);
                    const isFull = leaguePlayers.length >= league.teams_limit;
                    const isRegistered = currentUser.metadata?.league === league.code;

                    const card = document.createElement('div');
                    card.className = 'league-card';
                    card.innerHTML = `
                        <h3>${league.name}</h3>
                        <div class="teams">${leaguePlayers.length}/${league.teams_limit}</div>
                        <div style="color: ${isFull ? '#f44336' : '#4caf50'}; margin: 0.5rem 0;">
                            ${isFull ? 'üî¥ Full' : 'üü¢ Open'}
                        </div>
                        ${!currentUser.metadata?.league && !isFull ?
                            `<button class="btn btn-primary" onclick="joinLeague('${league.code}')" style="margin-top: 1rem;">Join League</button>` :
                            isRegistered ? '<p style="color: #4caf50; margin-top: 1rem;">‚úì You are in this league</p>' : ''}
                        ${currentUser.metadata?.league === league.code ? '<p style="color: #4caf50; margin-top: 1rem;">‚úì Your current league</p>' : ''}
                    `;
                    leagueList.appendChild(card);
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function joinLeague(leagueCode) {
            if (currentUser.metadata?.league) {
                showToast('You are already in a league', 'error');
                return;
            }

            try {
                const newMetadata = { ...currentUser.metadata, league: leagueCode };
                const mutation = `
                    mutation JoinLeague($id: uuid!, $metadata: jsonb!) {
                        update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata }) {
                            id
                        }
                    }
                `;
                await graphql(mutation, { id: currentUser.id, metadata: newMetadata });

                currentUser.metadata = newMetadata;
                await nhost.auth.refreshSession();

                showToast(`Joined league!`, 'success');
                loadLeagues();
                document.getElementById('leagueStandings').style.display = 'block';
                updateLeagueLeaderboard();
            } catch (err) {
                showToast('Failed to join league', 'error');
            }
        }

        async function updateLeagueLeaderboard() {
            if (!currentUser?.metadata?.league) return;

            try {
                const query = `
                    query GetLeagueLeaderboard($leagueCode: String!) {
                        users(where: { metadata: { _contains: { league: $leagueCode } } }) {
                            displayName
                            metadata
                        }
                    }
                `;
                const { users } = await graphql(query, { leagueCode: currentUser.metadata.league });

                const leaguePlayers = users.map(u => ({
                    efootballUser: u.metadata?.efootballUser || u.displayName,
                    country: u.metadata?.country,
                    p: u.metadata?.leagueMatchesPlayed || 0,
                    w: u.metadata?.leagueWins || 0,
                    d: u.metadata?.leagueDraws || 0,
                    l: u.metadata?.leagueLosses || 0,
                    gf: u.metadata?.leagueGoalsFor || 0,
                    ga: u.metadata?.leagueGoalsAgainst || 0,
                    gd: (u.metadata?.leagueGoalsFor || 0) - (u.metadata?.leagueGoalsAgainst || 0),
                    pts: u.metadata?.leaguePoints || 0
                })).sort((a, b) => {
                    if (b.pts !== a.pts) return b.pts - a.pts;
                    if (b.gd !== a.gd) return b.gd - a.gd;
                    return b.gf - a.gf;
                });

                const tbody = document.getElementById('leagueLeaderboardBody');
                tbody.innerHTML = leaguePlayers.map((player, index) => {
                    const rowClass = index < 3 ? `rank-${index + 1}` : '';
                    return `
                        <tr class="${rowClass}">
                            <td><strong>#${index + 1}</strong></td>
                            <td>${player.efootballUser}</td>
                            <td>${player.country || 'N/A'}</td>
                            <td>${player.p}</td>
                            <td>${player.w}</td>
                            <td>${player.d}</td>
                            <td>${player.l}</td>
                            <td>${player.gf}</td>
                            <td>${player.ga}</td>
                            <td>${player.gd}</td>
                            <td><strong style="color: #00d4ff;">${player.pts}</strong></td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error(err);
            }
        }

        // Result Submission
        async function openResultModal(matchId) {
            try {
                const query = `
                    query GetMatch($id: uuid!) {
                        matches_by_pk(id: $id) {
                            id
                            player1_id
                            player2_id
                            player1 { displayName metadata }
                            player2 { displayName metadata }
                        }
                    }
                `;
                const { matches_by_pk: match } = await graphql(query, { id: matchId });
                if (!match) return;

                const isPlayer1 = match.player1_id === currentUser.id;
                const opponent = isPlayer1 ? match.player2 : match.player1;
                const opponentName = opponent?.metadata?.efootballUser || opponent?.displayName || 'Unknown';

                document.getElementById('resultMatchId').value = matchId;
                document.getElementById('resultOpponent').value = opponentName;

                document.getElementById('yourScore').value = '';
                document.getElementById('opponentScore').value = '';
                document.getElementById('matchScreenshot').value = '';
                document.getElementById('matchVideo').value = '';

                document.getElementById('resultModal').classList.add('active');
            } catch (err) {
                console.error(err);
            }
        }

        async function submitResult(event) {
            event.preventDefault();

            const matchId = document.getElementById('resultMatchId').value;

            try {
                const queryMatch = `
                    query GetMatch($id: uuid!) {
                        matches_by_pk(id: $id) {
                            id
                            type
                            player1_id
                            player2_id
                            player1 { id metadata displayName }
                            player2 { id metadata displayName }
                        }
                    }
                `;
                const { matches_by_pk: match } = await graphql(queryMatch, { id: matchId });
                if (!match) return;

                const yourScore = parseInt(document.getElementById('yourScore').value);
                const opponentScore = parseInt(document.getElementById('opponentScore').value);
                const screenshot = document.getElementById('matchScreenshot').files[0];

                if (!screenshot) {
                    showToast('Please upload a screenshot', 'error');
                    return;
                }

                const isPlayer1 = match.player1_id === currentUser.id;
                const opponent = isPlayer1 ? match.player2 : match.player1;

                showToast('ü§ñ AI verifying your result...', 'info');

                const verification = await aiVerifier.verifyResult(match, yourScore, opponentScore, screenshot);

                if (verification.verified) {
                    const resultObj = {
                        player1Score: isPlayer1 ? yourScore : opponentScore,
                        player2Score: isPlayer1 ? opponentScore : yourScore
                    };

                    const updateMatchMutation = `
                        mutation UpdateMatch($id: uuid!, $result: jsonb!) {
                            update_matches_by_pk(pk_columns: { id: $id }, _set: { status: "completed", result: $result }) {
                                id
                            }
                        }
                    `;
                    await graphql(updateMatchMutation, { id: matchId, result: resultObj });

                    // Helper to calculate new stats
                    const calcNewStats = (user, scored, conceded, isWin, isDraw, isLoss) => {
                        const meta = { ...(user.metadata || {}) };
                        if (match.type === 'freeplay') {
                            meta.freePlayPoints = (meta.freePlayPoints || 0) + (isWin ? 3 : isDraw ? 1 : 0);
                            meta.matchesPlayed = (meta.matchesPlayed || 0) + 1;
                            meta.wins = (meta.wins || 0) + (isWin ? 1 : 0);
                            meta.draws = (meta.draws || 0) + (isDraw ? 1 : 0);
                            meta.losses = (meta.losses || 0) + (isLoss ? 1 : 0);
                            meta.goalsFor = (meta.goalsFor || 0) + scored;
                            meta.goalsAgainst = (meta.goalsAgainst || 0) + conceded;
                        } else {
                            meta.leaguePoints = (meta.leaguePoints || 0) + (isWin ? 3 : isDraw ? 1 : 0);
                            meta.leagueMatchesPlayed = (meta.leagueMatchesPlayed || 0) + 1;
                            meta.leagueWins = (meta.leagueWins || 0) + (isWin ? 1 : 0);
                            meta.leagueDraws = (meta.leagueDraws || 0) + (isDraw ? 1 : 0);
                            meta.leagueLosses = (meta.leagueLosses || 0) + (isLoss ? 1 : 0);
                            meta.leagueGoalsFor = (meta.leagueGoalsFor || 0) + scored;
                            meta.leagueGoalsAgainst = (meta.leagueGoalsAgainst || 0) + conceded;
                        }
                        return meta;
                    };

                    const userWin = yourScore > opponentScore;
                    const userDraw = yourScore === opponentScore;
                    const userLoss = yourScore < opponentScore;

                    const newUserMetadata = calcNewStats(currentUser, yourScore, opponentScore, userWin, userDraw, userLoss);
                    const newOpponentMetadata = calcNewStats(opponent, opponentScore, yourScore, userLoss, userDraw, userWin);

                    const updateUserMutation = `
                        mutation UpdateUserMetadata($id: uuid!, $metadata: jsonb!) {
                            update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata }) {
                                id
                            }
                        }
                    `;

                    await graphql(updateUserMutation, { id: currentUser.id, metadata: newUserMetadata });
                    await graphql(updateUserMutation, { id: opponent.id, metadata: newOpponentMetadata });

                    // Sync local state
                    currentUser.metadata = newUserMetadata;
                    await nhost.auth.refreshSession();

                    closeModal('resultModal');
                    updateStats();
                    loadActiveMatches();
                    updateFreePlayLeaderboard();
                    if (currentUser.metadata.league) {
                        updateLeagueLeaderboard();
                    }

                    showToast('‚úÖ Result verified and recorded!', 'success');
                } else {
                    showToast('‚ùå ' + verification.issues.join(', '), 'error');
                }
            } catch (err) {
                showToast('Failed to submit result', 'error');
                console.error(err);
            }
        }

        // Chat Functions
        async function openChat(matchId) {
            try {
                const query = `
                    query GetMatch($id: uuid!) {
                        matches_by_pk(id: $id) {
                            id
                            player1_id
                            player2_id
                            player1 { displayName metadata }
                            player2 { displayName metadata }
                        }
                    }
                `;
                const { matches_by_pk: match } = await graphql(query, { id: matchId });
                if (!match) return;

                currentChatMatch = match;
                const isPlayer1 = match.player1_id === currentUser.id;
                const opponent = isPlayer1 ? match.player2 : match.player1;
                const opponentName = opponent?.metadata?.efootballUser || opponent?.displayName || 'Unknown';

                document.getElementById('chatOpponent').textContent = opponentName;
                document.getElementById('chatContainer').classList.add('active');

                loadChatMessages(matchId);
            } catch (err) {
                console.error(err);
            }
        }

        function closeChat() {
            document.getElementById('chatContainer').classList.remove('active');
            currentChatMatch = null;
        }

        async function loadChatMessages(matchId) {
            try {
                const query = `
                    query GetChatMessages($matchId: uuid!) {
                        chat_messages(where: { match_id: { _eq: $matchId } }, order_by: { timestamp: asc }) {
                            sender_id
                            text
                            timestamp
                        }
                    }
                `;
                const { chat_messages: messages } = await graphql(query, { matchId });
                const container = document.getElementById('chatMessages');
                container.innerHTML = '';

                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender_id === currentUser.id ? 'sent' : 'received'}`;
                    messageDiv.innerHTML = `
                        ${msg.text}<br>
                        <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
                    `;
                    container.appendChild(messageDiv);
                });
                container.scrollTop = container.scrollHeight;
            } catch (err) {
                console.error(err);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentChatMatch) return;

            try {
                const mutation = `
                    mutation SendMessage($matchId: uuid!, $senderId: uuid!, $text: String!) {
                        insert_chat_messages_one(object: {
                            match_id: $matchId,
                            sender_id: $senderId,
                            text: $text
                        }) {
                            id
                        }
                    }
                `;
                await graphql(mutation, {
                    matchId: currentChatMatch.id,
                    senderId: currentUser.id,
                    text: text
                });

                input.value = '';
                loadChatMessages(currentChatMatch.id);
            } catch (err) {
                showToast('Failed to send message', 'error');
            }
        }

        // Phase Winners Display
        async function updatePhaseWinnersDisplay() {
            try {
                const query = `
                    query GetPhaseWinners {
                        users {
                            displayName
                            metadata
                        }
                    }
                `;
                const { users } = await graphql(query);

                const freePlayTop3 = document.getElementById('freePlayPhaseTop3');
                const leagueChampions = document.getElementById('leagueChampions');

                // Free Play Top 3
                const topFreePlay = users
                    .filter(u => u.metadata?.role !== 'admin')
                    .sort((a, b) => (b.metadata?.freePlayPoints || 0) - (a.metadata?.freePlayPoints || 0))
                    .slice(0, 3);

                if (topFreePlay.length === 0) {
                    freePlayTop3.innerHTML = '<p style="color: #b0b0b0;">No players yet</p>';
                } else {
                    freePlayTop3.innerHTML = `
                        <div class="podium">
                            ${topFreePlay.map((player, index) => {
                                const places = ['2nd', '1st', '3rd'];
                                const podiumClass = index === 0 ? 'podium-2' : index === 1 ? 'podium-1' : 'podium-3';
                                return `
                                    <div class="podium-place ${podiumClass}">
                                        <div class="podium-card">
                                            <div class="podium-rank">#${places[index]}</div>
                                            <div><strong>${player.metadata?.efootballUser || player.displayName}</strong></div>
                                            <div>${player.metadata?.country || 'N/A'}</div>
                                            <div>${player.metadata?.freePlayPoints || 0} pts</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                // League Champions
                const queryLeagues = `query GetLeagues { leagues { code name } }`;
                const { leagues } = await graphql(queryLeagues);

                const leaguesWithChampions = leagues
                    .map(league => {
                        const champion = users
                            .filter(u => u.metadata?.league === league.code)
                            .sort((a, b) => (b.metadata?.leaguePoints || 0) - (a.metadata?.leaguePoints || 0))[0];

                        return { league: league.name, champion };
                    })
                    .filter(item => item.champion);

                if (leaguesWithChampions.length === 0) {
                    leagueChampions.innerHTML = '<p style="color: #b0b0b0;">No league champions yet</p>';
                } else {
                    leagueChampions.innerHTML = leaguesWithChampions.map(item => `
                        <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <strong style="color: #00d4ff;">${item.league}:</strong>
                            ${item.champion ? `${item.champion.metadata?.efootballUser || item.champion.displayName} (${item.champion.metadata?.country || 'N/A'}) - ${item.champion.metadata?.leaguePoints || 0} pts` : 'No champion yet'}
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Full Leaderboard
        async function showFullLeaderboard() {
            try {
                const query = `
                    query GetAllPlayers {
                        users {
                            displayName
                            metadata
                        }
                    }
                `;
                const { users } = await graphql(query);

                const allPlayers = users
                    .filter(u => u.metadata?.role !== 'admin')
                    .map(u => {
                        const m = u.metadata || {};
                        return {
                            efootballUser: m.efootballUser || u.displayName,
                            country: m.country,
                            totalPoints: (m.freePlayPoints || 0) + (m.leaguePoints || 0),
                            totalGoalsFor: (m.goalsFor || 0) + (m.leagueGoalsFor || 0),
                            totalGoalsAgainst: (m.goalsAgainst || 0) + (m.leagueGoalsAgainst || 0),
                            totalMatches: (m.matchesPlayed || 0) + (m.leagueMatchesPlayed || 0),
                            totalWins: (m.wins || 0) + (m.leagueWins || 0),
                            totalDraws: (m.draws || 0) + (m.leagueDraws || 0),
                            totalLosses: (m.losses || 0) + (m.leagueLosses || 0)
                        };
                    })
                    .sort((a, b) => {
                        if (b.totalPoints !== a.totalPoints) return b.totalPoints - a.totalPoints;
                        const gdA = (a.totalGoalsFor - a.totalGoalsAgainst);
                        const gdB = (b.totalGoalsFor - b.totalGoalsAgainst);
                        if (gdB !== gdA) return gdB - gdA;
                        return b.totalGoalsFor - a.totalGoalsFor;
                    });

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px;">
                        <div class="modal-header">
                            <h2>Overall Leaderboard</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Country</th>
                                    <th>P</th>
                                    <th>W</th>
                                    <th>D</th>
                                    <th>L</th>
                                    <th>GF</th>
                                    <th>GA</th>
                                    <th>GD</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allPlayers.map((player, index) => {
                                    const rowClass = index < 3 ? `rank-${index + 1}` : '';
                                    const gd = (player.totalGoalsFor || 0) - (player.totalGoalsAgainst || 0);
                                    return `
                                    <tr class="${rowClass}">
                                        <td><strong>#${index + 1}</strong></td>
                                        <td>${player.efootballUser}</td>
                                        <td>${player.country || 'N/A'}</td>
                                        <td>${player.totalMatches || 0}</td>
                                        <td>${player.totalWins || 0}</td>
                                        <td>${player.totalDraws || 0}</td>
                                        <td>${player.totalLosses || 0}</td>
                                        <td>${player.totalGoalsFor || 0}</td>
                                        <td>${player.totalGoalsAgainst || 0}</td>
                                        <td>${gd}</td>
                                        <td><strong style="color: #00d4ff;">${player.totalPoints}</strong></td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (err) {
                console.error(err);
            }
        }

        // Admin Functions
        function showAdminModal() {
            closeMobileMenu();
            if (!currentUser || currentUser.metadata?.role !== 'admin') {
                showToast('Unauthorized', 'error');
                return;
            }
            
            loadAdminData();
            document.getElementById('adminModal').classList.add('active');
        }

        async function loadAdminData() {
            try {
                const query = `
                    query GetAdminData {
                        users {
                            id
                            displayName
                            email
                            metadata
                        }
                        matches(where: { status: { _eq: "completed" } }) {
                            id
                            player1_id
                            player2_id
                            result
                            createdAt
                            player1 { displayName metadata }
                            player2 { displayName metadata }
                        }
                        leagues {
                            code
                            name
                            teams_limit
                        }
                        free_play_phase_winners(order_by: { date: desc }) {
                            phase
                            winners
                            date
                        }
                    }
                `;
                const { users, matches: completedMatches, leagues, free_play_phase_winners } = await graphql(query);

                // Load players
                const playersBody = document.getElementById('adminPlayersBody');
                playersBody.innerHTML = users
                    .filter(u => u.metadata?.role !== 'admin')
                    .map(user => {
                        const m = user.metadata || {};
                        return `
                            <tr>
                                <td>${user.id}</td>
                                <td>${m.displayName || user.displayName}</td>
                                <td>${user.email}</td>
                                <td>${m.country || 'N/A'}</td>
                                <td><span class="status-badge status-${m.status || 'active'}">${m.status || 'active'}</span></td>
                                <td>${m.freePlayPoints || 0}</td>
                                <td>${m.leaguePoints || 0}</td>
                                <td class="admin-controls">
                                    <button class="btn btn-warning" onclick="suspendPlayer('${user.id}')">${m.status === 'suspended' ? 'Unsuspend' : 'Suspend'}</button>
                                    <button class="btn btn-danger" onclick="blockPlayer('${user.id}')">${m.status === 'blocked' ? 'Unblock' : 'Block'}</button>
                                    <button class="btn btn-danger" onclick="removePlayer('${user.id}')">Remove</button>
                                    <button class="btn btn-primary" onclick="openDeductPointsModal('${user.id}', '${m.displayName || user.displayName}')">Deduct Points</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                // Load matches
                const matchesBody = document.getElementById('adminMatchesBody');
                matchesBody.innerHTML = completedMatches
                    .map(match => {
                        const p1Name = match.player1?.metadata?.efootballUser || match.player1?.displayName || 'Unknown';
                        const p2Name = match.player2?.metadata?.efootballUser || match.player2?.displayName || 'Unknown';
                        return `
                            <tr>
                                <td>${match.id}</td>
                                <td>${p1Name} vs ${p2Name}</td>
                                <td>${match.result?.player1Score || 0} - ${match.result?.player2Score || 0}</td>
                                <td>${new Date(match.createdAt).toLocaleDateString()}</td>
                                <td><span class="status-badge status-active">Completed</span></td>
                                <td>
                                    <button class="btn btn-warning" onclick="revertMatch('${match.id}')">Revert</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                // Load leagues
                const leaguesBody = document.getElementById('adminLeaguesBody');
                leaguesBody.innerHTML = leagues.map(league => {
                    const leaguePlayers = users.filter(u => u.metadata?.league === league.code);
                    const leader = [...leaguePlayers].sort((a, b) => (b.metadata?.leaguePoints || 0) - (a.metadata?.leaguePoints || 0))[0];
                    const leaderName = leader ? (leader.metadata?.efootballUser || leader.displayName) : 'No players';

                    return `
                        <tr>
                            <td><strong style="color: #00d4ff;">${league.name}</strong></td>
                            <td>${leaguePlayers.length}/${league.teams_limit}</td>
                            <td>${leaguePlayers.length >= league.teams_limit ?
                                '<span class="status-badge status-active">Full</span>' :
                                '<span class="status-badge status-suspended">Open</span>'}</td>
                            <td>${leader ? `${leaderName} (${leader.metadata?.leaguePoints || 0} pts)` : 'No players'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewLeagueDetails('${league.code}')">View</button>
                                <button class="btn btn-warning" onclick="resetLeague('${league.code}')">Reset</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Load phase winners
                const phaseWinnersList = document.getElementById('phaseWinnersList');
                if (free_play_phase_winners.length === 0) {
                    phaseWinnersList.innerHTML = '<p style="color: #b0b0b0;">No previous phases</p>';
                } else {
                    phaseWinnersList.innerHTML = free_play_phase_winners.map((phase, index) => `
                        <div style="margin: 1rem 0; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <strong style="color: #00d4ff;">Phase ${phase.phase}</strong> - ${new Date(phase.date).toLocaleDateString()}
                            <br>Winners: ${phase.winners.join(', ')}
                        </div>
                    `).join('');
                }

                // Load points deduction dropdown
                const pointsSelect = document.getElementById('pointsPlayerSelect');
                pointsSelect.innerHTML = '<option value="">Choose a player...</option>' +
                    users.filter(u => u.metadata?.role !== 'admin').map(u =>
                        `<option value="${u.id}">${u.displayName} (${u.metadata?.efootballUser || 'N/A'})</option>`
                    ).join('');
            } catch (err) {
                console.error(err);
            }
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).classList.add('active');
        }

        async function suspendPlayer(playerId) {
            try {
                const queryUser = `query GetUser($id: uuid!) { users_by_pk(id: $id) { id metadata } }`;
                const { users_by_pk: user } = await graphql(queryUser, { id: playerId });
                if (!user) return;

                const meta = { ...(user.metadata || {}) };
                meta.status = meta.status === 'suspended' ? 'active' : 'suspended';

                const mutation = `
                    mutation UpdateUserStatus($id: uuid!, $metadata: jsonb!) {
                        update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata }) {
                            id
                        }
                    }
                `;
                await graphql(mutation, { id: playerId, metadata: meta });
                loadAdminData();
                showToast(`Player status updated`, 'success');
            } catch (err) {
                showToast('Failed to update player status', 'error');
            }
        }

        async function blockPlayer(playerId) {
            try {
                const queryUser = `query GetUser($id: uuid!) { users_by_pk(id: $id) { id metadata } }`;
                const { users_by_pk: user } = await graphql(queryUser, { id: playerId });
                if (!user) return;

                const meta = { ...(user.metadata || {}) };
                meta.status = meta.status === 'blocked' ? 'active' : 'blocked';

                const mutation = `
                    mutation UpdateUserStatus($id: uuid!, $metadata: jsonb!) {
                        update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata }) {
                            id
                        }
                    }
                `;
                await graphql(mutation, { id: playerId, metadata: meta });
                loadAdminData();
                showToast(`Player status updated`, 'success');
            } catch (err) {
                showToast('Failed to update player status', 'error');
            }
        }

        async function removePlayer(playerId) {
            if (confirm('Are you sure you want to remove this player?')) {
                try {
                    const mutation = `
                        mutation DeleteUser($id: uuid!) {
                            delete_users_by_pk(id: $id) {
                                id
                            }
                        }
                    `;
                    await graphql(mutation, { id: playerId });
                    loadAdminData();
                    showToast('Player removed', 'info');
                } catch (err) {
                    showToast('Failed to remove player. They might have existing matches.', 'error');
                }
            }
        }

        function openDeductPointsModal(playerId, playerName) {
            document.getElementById('deductPlayerId').value = playerId;
            document.getElementById('deductPlayerName').value = playerName;
            document.getElementById('deductAmount').value = '';
            document.getElementById('deductReason').value = '';
            document.getElementById('deductPointsModal').classList.add('active');
        }

        async function deductPointsFromModal(event) {
            event.preventDefault();

            const playerId = document.getElementById('deductPlayerId').value;
            const amount = parseInt(document.getElementById('deductAmount').value);
            const reason = document.getElementById('deductReason').value;

            try {
                const queryUser = `query GetUser($id: uuid!) { users_by_pk(id: $id) { id metadata } }`;
                const { users_by_pk: user } = await graphql(queryUser, { id: playerId });
                if (!user) return;

                const meta = { ...(user.metadata || {}) };
                meta.freePlayPoints = Math.max(0, (meta.freePlayPoints || 0) - amount);

                const mutation = `
                    mutation UpdateUserMetadata($id: uuid!, $metadata: jsonb!) {
                        update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata }) {
                            id
                        }
                    }
                `;
                await graphql(mutation, { id: playerId, metadata: meta });
                
                closeModal('deductPointsModal');
                loadAdminData();
                updateFreePlayLeaderboard();
                showToast(`Deducted ${amount} points`, 'warning');
            } catch (err) {
                showToast('Failed to deduct points', 'error');
            }
        }

        async function loadPlayerForDeduction() {
            const playerId = document.getElementById('pointsPlayerSelect').value;
            if (!playerId) {
                document.getElementById('deductionForm').style.display = 'none';
                return;
            }

            try {
                const queryUser = `query GetUser($id: uuid!) { users_by_pk(id: $id) { id displayName metadata } }`;
                const { users_by_pk: user } = await graphql(queryUser, { id: playerId });
                if (user) {
                    const m = user.metadata || {};
                    document.getElementById('pointsPlayerName').value = m.displayName || user.displayName;
                    document.getElementById('pointsCurrentFree').value = m.freePlayPoints || 0;
                    document.getElementById('pointsCurrentLeague').value = m.leaguePoints || 0;
                    document.getElementById('deductionForm').style.display = 'block';
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function deductPoints() {
            const playerId = document.getElementById('pointsPlayerSelect').value;
            const type = document.getElementById('pointsType').value;
            const amount = parseInt(document.getElementById('pointsAmount').value);
            const reason = document.getElementById('pointsReason').value;

            if (!playerId || !amount || !reason) {
                showToast('Please fill all fields', 'error');
                return;
            }

            try {
                const queryUser = `query GetUser($id: uuid!) { users_by_pk(id: $id) { id metadata } }`;
                const { users_by_pk: user } = await graphql(queryUser, { id: playerId });
                if (!user) return;

                const meta = { ...(user.metadata || {}) };
                if (type === 'free' || type === 'both') {
                    meta.freePlayPoints = Math.max(0, (meta.freePlayPoints || 0) - amount);
                }
                if (type === 'league' || type === 'both') {
                    meta.leaguePoints = Math.max(0, (meta.leaguePoints || 0) - amount);
                }

                const mutation = `
                    mutation UpdateUserMetadata($id: uuid!, $metadata: jsonb!) {
                        update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata }) {
                            id
                        }
                    }
                `;
                await graphql(mutation, { id: playerId, metadata: meta });
                
                // Log the deduction
                console.log(`Deducted ${amount} ${type} points. Reason: ${reason}`);
                
                loadAdminData();
                updateFreePlayLeaderboard();
                if (meta.league) updateLeagueLeaderboard();
                
                showToast(`Deducted ${amount} points`, 'warning');
                
                // Reset form
                document.getElementById('pointsPlayerSelect').value = '';
                document.getElementById('deductionForm').style.display = 'none';
                document.getElementById('pointsAmount').value = '';
                document.getElementById('pointsReason').value = '';
            } catch (err) {
                showToast('Failed to deduct points', 'error');
            }
        }

        async function revertMatch(matchId) {
            if (confirm('Are you sure you want to revert this match? Points will be recalculated.')) {
                try {
                    const mutation = `
                        mutation RevertMatch($id: uuid!) {
                            update_matches_by_pk(pk_columns: { id: $id }, _set: { status: "pending", result: null }) {
                                id
                            }
                        }
                    `;
                    await graphql(mutation, { id: matchId });
                    loadAdminData();
                    showToast('Match reverted', 'info');
                } catch (err) {
                    showToast('Failed to revert match', 'error');
                }
            }
        }

        async function viewLeagueDetails(leagueCode) {
            try {
                const query = `query GetLeaguePlayers($leagueCode: String!) { users(where: { metadata: { _contains: { league: $leagueCode } } }) { displayName metadata } }`;
                const { users: leaguePlayersRaw } = await graphql(query, { leagueCode });

                const leaguePlayers = leaguePlayersRaw.map(u => ({
                    efootballUser: u.metadata?.efootballUser || u.displayName,
                    country: u.metadata?.country,
                    p: u.metadata?.leagueMatchesPlayed || 0,
                    w: u.metadata?.leagueWins || 0,
                    d: u.metadata?.leagueDraws || 0,
                    l: u.metadata?.leagueLosses || 0,
                    gf: u.metadata?.leagueGoalsFor || 0,
                    ga: u.metadata?.leagueGoalsAgainst || 0,
                    gd: (u.metadata?.leagueGoalsFor || 0) - (u.metadata?.leagueGoalsAgainst || 0),
                    pts: u.metadata?.leaguePoints || 0
                })).sort((a, b) => b.pts - a.pts);

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2>League Details</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Country</th>
                                    <th>P</th>
                                    <th>W</th>
                                    <th>D</th>
                                    <th>L</th>
                                    <th>GF</th>
                                    <th>GA</th>
                                    <th>GD</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaguePlayers.map((player, index) => `
                                    <tr>
                                        <td><strong>#${index + 1}</strong></td>
                                        <td>${player.efootballUser}</td>
                                        <td>${player.country || 'N/A'}</td>
                                        <td>${player.p}</td>
                                        <td>${player.w}</td>
                                        <td>${player.d}</td>
                                        <td>${player.l}</td>
                                        <td>${player.gf}</td>
                                        <td>${player.ga}</td>
                                        <td>${player.gd}</td>
                                        <td><strong style="color: #00d4ff;">${player.pts}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (err) {
                console.error(err);
            }
        }

        async function resetLeague(leagueCode) {
            if (confirm(`Reset league? All stats will be cleared.`)) {
                try {
                    const query = `query GetLeaguePlayers($leagueCode: String!) { users(where: { metadata: { _contains: { league: $leagueCode } } }) { id metadata } }`;
                    const { users } = await graphql(query, { leagueCode });

                    const mutation = `mutation UpdateUserMetadata($id: uuid!, $metadata: jsonb!) { update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata }) { id } }`;
                    for (const user of users) {
                        const m = { ...(user.metadata || {}) };
                        m.leaguePoints = 0;
                        m.leagueMatchesPlayed = 0;
                        m.leagueWins = 0;
                        m.leagueDraws = 0;
                        m.leagueLosses = 0;
                        m.leagueGoalsFor = 0;
                        m.leagueGoalsAgainst = 0;
                        await graphql(mutation, { id: user.id, metadata: m });
                    }

                    loadAdminData();
                    if (currentUser.metadata?.league === leagueCode) {
                        updateLeagueLeaderboard();
                    }
                    showToast('League reset', 'success');
                } catch (err) {
                    showToast('Failed to reset league', 'error');
                }
            }
        }

        async function endFreePlayPhase() {
            if (confirm('End current phase and declare winners?')) {
                try {
                    const leaderboardQuery = `
                        query GetLeaderboard {
                            free_play_leaderboard(order_by: {pts: desc}, limit: 3) {
                                player_name
                                country
                            }
                        }
                    `;
                    const { free_play_leaderboard } = await graphql(leaderboardQuery);
                    const top3 = free_play_leaderboard.map(p => `${p.player_name} (${p.country || 'N/A'})`);

                    const insertMutation = `
                        mutation InsertPhaseWinner($winners: jsonb!) {
                            insert_free_play_phase_winners_one(object: {
                                winners: $winners
                            }) {
                                id
                            }
                        }
                    `;
                    await graphql(insertMutation, { winners: top3 });

                    const getUsersQuery = `query GetUsers { users { id metadata } }`;
                    const { users } = await graphql(getUsersQuery);

                    const updateUserMutation = `
                        mutation UpdateUserMetadata($id: uuid!, $metadata: jsonb!) {
                            update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata }) {
                                id
                            }
                        }
                    `;

                    for (const user of users) {
                        const m = { ...(user.metadata || {}) };
                        m.freePlayPoints = 0;
                        m.matchesPlayed = 0;
                        m.wins = 0;
                        m.draws = 0;
                        m.losses = 0;
                        m.goalsFor = 0;
                        m.goalsAgainst = 0;
                        await graphql(updateUserMutation, { id: user.id, metadata: m });
                    }

                    loadAdminData();
                    updateFreePlayLeaderboard();
                    updatePhaseWinnersDisplay();

                    showToast('Phase ended! Winners recorded.', 'success');
                } catch (err) {
                    showToast('Failed to end phase', 'error');
                }
            }
        }

        async function resetAllPhases() {
            if (confirm('Reset all phase history? This cannot be undone.')) {
                try {
                    const mutation = `mutation DeleteAllPhaseWinners { delete_free_play_phase_winners(where: {}) { affected_rows } }`;
                    await graphql(mutation);

                    loadAdminData();
                    updatePhaseWinnersDisplay();
                    showToast('All phases reset', 'info');
                } catch (err) {
                    showToast('Failed to reset phases', 'error');
                }
            }
        }

        // Profile Functions
        function showEditProfile() {
            const m = currentUser.metadata || {};
            document.getElementById('editName').value = currentUser.displayName || '';
            document.getElementById('editCountrySearch').value = m.country || '';
            document.getElementById('editEfootball').value = m.efootballUser || '';
            document.getElementById('editProfileModal').classList.add('active');
        }

        async function updateProfile(event) {
            event.preventDefault();

            const country = document.getElementById('editCountrySearch').value;
            if (!country) {
                showToast('Please enter your country', 'error');
                return;
            }

            const name = document.getElementById('editName').value;
            const efootballUser = document.getElementById('editEfootball').value;

            try {
                const newMetadata = {
                    ...(currentUser.metadata || {}),
                    country,
                    efootballUser
                };
                const mutation = `
                    mutation UpdateProfile($id: uuid!, $metadata: jsonb!, $displayName: String!) {
                        update_users_by_pk(pk_columns: { id: $id }, _set: { metadata: $metadata, displayName: $displayName }) {
                            id
                        }
                    }
                `;
                await graphql(mutation, {
                    id: currentUser.id,
                    metadata: newMetadata,
                    displayName: name
                });

                currentUser.metadata = newMetadata;
                currentUser.displayName = name;
                await nhost.auth.refreshSession();

                closeModal('editProfileModal');
                showProfile();
                updateFreePlayLeaderboard();
                if (currentUser.metadata.league) updateLeagueLeaderboard();
                showToast('Profile updated successfully', 'success');
            } catch (err) {
                showToast('Failed to update profile', 'error');
            }
        }

        // Modal Functions
        function showLoginModal() {
            closeMobileMenu();
            document.getElementById('loginModal').classList.add('active');
        }

        function showRegisterModal() {
            closeMobileMenu();
            populateCountries();
            document.getElementById('registerModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function switchToLogin() {
            closeModal('registerModal');
            showLoginModal();
        }

        function switchToRegister() {
            closeModal('loginModal');
            showRegisterModal();
        }


        // Click outside to close country lists
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.country-search')) {
                document.getElementById('countryList')?.classList.remove('active');
                document.getElementById('editCountryList')?.classList.remove('active');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeAdmin();
            populateCountries();
        });

        // Expose functions to window for HTML event handlers
        Object.assign(window, {
            populateCountries, showLeaderboard, logout, showAdminModal,
            switchMode, handleRegister, handleLogin, findOpponent,
            openResultModal, openChat, submitResult, sendMessage,
            switchAdminTab, suspendPlayer, blockPlayer, removePlayer,
            openDeductPointsModal, deductPointsFromModal, deductPoints,
            revertMatch, viewLeagueDetails, resetLeague, endFreePlayPhase,
            resetAllPhases, showEditProfile, updateProfile, closeModal,
            switchToLogin, switchToRegister, filterCountries, filterEditCountries,
            showCountryList, showEditCountryList, selectCountry, selectEditCountry,
            closeChat, joinLeague, loadPlayerForDeduction,
            updateProfileDisplay, loadLeagues, updateLeagueLeaderboard
        });
    </script>
</body>
</html>
